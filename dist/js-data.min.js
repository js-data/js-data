/*!
* js-data
* @version 3.0.6 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t((e=e||self).JSData={})}(this,function(e){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _get(e,t,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function _get(e,t,n){var i=function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function _toConsumableArray(e){return function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function r(e){return t.call(e)}function s(e){return!!e&&"object"===_typeof(e)&&e.constructor===Object}function v(e,t,n){e&&e._set?e._set("props.".concat(t),n):A.set(e,t,n)}function w(e,t,n){e&&e._set?e._set("links.".concat(t),n):A.set(e,t,n)}function x(){_classCallCheck(this,x);var n={};Object.defineProperties(this,{_get:{value:function value(e){return A.get(n,e)}},_set:{value:function value(e,t){return A.set(n,e,t)}},_unset:{value:function value(e){return A.unset(n,e)}}})}var n="[object Number]",o="[object RegExp]",t=Object.prototype.toString,a=/^(.+)\.(.+)$/,l={400:function _(e,t,n){return"expected: ".concat(e,", found: ").concat(n?t:_typeof(t))},404:function _(e){return"".concat(e," not found")}},A={Promise:Promise,_:function _(n,e){A.forOwn(e,function(e,t){t&&void 0===n[t]&&!A.isFunction(e)&&0!==t.indexOf("_")&&(n[t]=e)})},_forRelation:function _forRelation(e,t,n,i){var r,o=0<arguments.length&&void 0!==e?e:{},a=1<arguments.length?t:void 0,s=2<arguments.length?n:void 0,l=3<arguments.length?i:void 0,u=a.relation,c=null;if(o.with||(o.with=[]),0<=(r=A._getIndex(o.with,u))?c=u:0<=(r=A._getIndex(o.with,a.localField))&&(c=a.localField),o.withAll)s.call(l,a,{});else if(c){var f={};A.fillIn(f,a.getRelation()),A.fillIn(f,o),f.with=o.with.slice(),f._activeWith=f.with.splice(r,1)[0],f.with.forEach(function(e,t){e&&0===e.indexOf(c)&&e.length>=c.length&&"."===e[c.length]?f.with[t]=e.substr(c.length+1):f.with[t]=""}),s.call(l,a,f)}},_getIndex:function _getIndex(e,n){var i=-1;return e.forEach(function(e,t){return e===n||A.isObject(e)&&e.relation===n?(i=t,!1):void 0}),i},addHiddenPropsToTarget:function addHiddenPropsToTarget(e,n){var i={};Object.keys(n).forEach(function(e){var t=Object.getOwnPropertyDescriptor(n,e);t.enumerable=!1,i[e]=t}),Object.defineProperties(e,i)},areDifferent:function areDifferent(e,t,n){var i=2<arguments.length&&void 0!==n?n:{},r=A.diffObjects(e,t,i);return 0<Object.keys(r.added).length+Object.keys(r.removed).length+Object.keys(r.changed).length},copy:function copy(e,n,t,i,r,o){if(n){if(e===n)throw A.err("".concat("utils",".copy"))(500,"Cannot copy! Source and destination are identical.");if(t=t||[],i=i||[],A.isObject(e)){var a=t.indexOf(e);if(-1!==a)return i[a];t.push(e),i.push(n)}var s,l;if(A.isArray(e))for(l=n.length=0;l<e.length;l++)s=A.copy(e[l],null,t,i,r,o),A.isObject(e[l])&&(t.push(e[l]),i.push(s)),n.push(s);else for(var u in A.isArray(n)?n.length=0:A.forOwn(n,function(e,t){delete n[t]}),e)if(Object.hasOwnProperty.call(e,u)){if(A.isBlacklisted(u,r))continue;s=A.copy(e[u],null,t,i,r,o),A.isObject(e[u])&&(t.push(e[u]),i.push(s)),n[u]=s}}else(n=e)&&(A.isArray(e)?n=A.copy(e,[],t,i,r,o):A.isDate(e)?n=new Date(e.getTime()):A.isRegExp(e)?(n=new RegExp(e.source,e.toString().match(/[^/]*$/)[0])).lastIndex=e.lastIndex:A.isObject(e)&&(n=o?A.copy(e,{},t,i,r,o):A.copy(e,Object.create(Object.getPrototypeOf(e)),t,i,r,o)));return n},deepFillIn:function deepFillIn(i,e){return e&&A.forOwn(e,function(e,t){var n=i[t];s(e)&&s(n)?A.deepFillIn(n,e):Object.hasOwnProperty.call(i,t)&&void 0!==i[t]||(i[t]=e)}),i},deepMixIn:function deepMixIn(e,t){if(t)for(var n in t){var i=t[n],r=e[n];s(i)&&s(r)?A.deepMixIn(r,i):e[n]=i}return e},diffObjects:function diffObjects(i,r,e){var t=2<arguments.length&&void 0!==e?e:{},o=t.equalsFn,n=t.ignore,a={added:{},changed:{},removed:{}};A.isFunction(o)||(o=A.deepEqual);var s=Object.keys(i).filter(function(e){return!A.isBlacklisted(e,n)}),l=Object.keys(r).filter(function(e){return!A.isBlacklisted(e,n)});return s.forEach(function(e){var t=r[e],n=i[e];o(t,n)||(void 0===t?a.added[e]=n:a.changed[e]=n)}),l.forEach(function(e){var t=r[e];void 0===i[e]&&void 0!==t&&(a.removed[e]=void 0)}),a},equal:function equal(e,t){return e==t},err:function err(i,r){return function(e){var t="[".concat(i,":").concat(r,"] "),n=l[e].apply(null,Array.prototype.slice.call(arguments,1));return n="".concat(t).concat(n,"\nhttp://www.js-data.io/v3.0/docs/errors#").concat(e),new Error(n)}},eventify:function eventify(e,s,r){e=e||this;var t={};s||r||(s=function getter(){return t},r=function setter(e){t=e}),Object.defineProperties(e,{emit:{value:function value(){for(var e=s.call(this)||{},t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r,o=n.shift(),a=e[o]||[];for(r=0;r<a.length;r++)a[r].f.apply(a[r].c,n);for(a=e.all||[],n.unshift(o),r=0;r<a.length;r++)a[r].f.apply(a[r].c,n)}},off:{value:function value(e,t){var n=s.call(this)[e];if(n)if(t){for(var i=0;i<n.length;i++)if(n[i].f===t){n.splice(i,1);break}}else n.splice(0,n.length);else r.call(this,{})}},on:{value:function value(e,t,n){s.call(this)||r.call(this,{});var i=s.call(this);i[e]=i[e]||[],i[e].push({c:n,f:t})}}})},fillIn:function fillIn(n,e){A.forOwn(e,function(e,t){Object.hasOwnProperty.call(n,t)&&void 0!==n[t]||(n[t]=e)})},findIndex:function findIndex(e,n){var i=-1;return e&&e.forEach(function(e,t){if(n(e))return i=t,!1}),i},forEachRelation:function forEachRelation(e,t,n,i){var r=e.relationList||[];r.length&&r.forEach(function(e){A._forRelation(t,e,n,i)})},forOwn:function forOwn(e,t,n){var i,r=Object.keys(e),o=r.length;for(i=0;i<o&&!1!==t.call(n,e[r[i]],r[i],e);i++);},fromJson:function fromJson(e){return A.isString(e)?JSON.parse(e):e},get:function get(e,t){if(t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(null==(e=e[t]))return;return e[i]}},getSuper:function getSuper(e,t){var n=t?e:e.constructor;return Object.hasOwnProperty.call(n,"__super__")?n.__super__:Object.getPrototypeOf(n)||n.__proto__},intersection:function intersection(e,t){if(!e||!t)return[];e=Array.isArray(e)?e:[e],t=Array.isArray(t)?t:[t];var n,i,r=[],o=e.length;for(i=0;i<o;i++)n=e[i],-1===r.indexOf(n)&&-1!==t.indexOf(n)&&r.push(n);return r},isArray:Array.isArray,isBlacklisted:function isBlacklisted(e,t){if(!t||!t.length)return!1;for(var n,i=0;i<t.length;i++)if(r(t[i])===o&&t[i].test(e)||t[i]===e)return!!(n=e);return!!n},isBoolean:function isBoolean(e){return"[object Boolean]"===r(e)},isDate:function isDate(e){return e&&"object"===_typeof(e)&&"[object Date]"===r(e)},isFunction:function isFunction(e){return"function"==typeof e||e&&"[object Function]"===r(e)},isInteger:function isInteger(e){return r(e)===n&&e==function toInteger(e){if(!e)return 0;if((e=+e)===1/0||e===-1/0)return 17976931348623157e292*(e<0?-1:1);var t=e%1;return e==e?t?e-t:e:0}(e)},isNull:function isNull(e){return null===e},isNumber:function isNumber(e){var t=_typeof(e);return"number"===t||e&&"object"===t&&r(e)===n},isObject:function isObject(e){return"[object Object]"===r(e)},isRegExp:function isRegExp(e){return r(e)===o},isSorN:function isSorN(e){return A.isString(e)||A.isNumber(e)},isString:function isString(e){return"string"==typeof e||e&&"object"===_typeof(e)&&"[object String]"===r(e)},isUndefined:function isUndefined(e){return void 0===e},logify:function logify(e){A.addHiddenPropsToTarget(e,{dbg:function dbg(){if(A.isFunction(this.log)){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))}},log:function log(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var r,o,a="".concat(e.toUpperCase(),": (").concat(this.name||this.constructor.name,")");if(A.isFunction(console[e]))(r=console)[e].apply(r,[a].concat(n));else(o=console).log.apply(o,[a].concat(n))}}})},noDupeAdd:function noDupeAdd(e,t,n){e&&this.findIndex(e,n)<0&&e.push(t)},omit:function omit(e,n){var i={};return A.forOwn(e,function(e,t){-1===n.indexOf(t)&&(i[t]=e)}),i},pick:function pick(n,e){return e.reduce(function(e,t){return e[t]=n[t],e},{})},plainCopy:function plainCopy(e){return A.copy(e,void 0,void 0,void 0,void 0,!0)},reject:function reject(e){return A.Promise.reject(e)},remove:function remove(e,t){if(e&&e.length){var n=this.findIndex(e,t);0<=n&&e.splice(n,1)}},resolve:function resolve(e){return A.Promise.resolve(e)},set:function set(n,e,t){if(A.isObject(e))A.forOwn(e,function(e,t){A.set(n,t,e)});else{var i=a.exec(e);i?function mkdirP(t,e){return e&&e.split(".").forEach(function(e){t[e]||(t[e]={}),t=t[e]}),t}(n,i[1])[i[2]]=t:n[e]=t}},deepEqual:function deepEqual(n,i){if(n===i)return!0;var r=!0;if(A.isArray(n)&&A.isArray(i)){if(n.length!==i.length)return!1;for(var e=n.length;e--;)if(!A.deepEqual(n[e],i[e]))return!1}else{if(!A.isObject(n)||!A.isObject(i))return!1;A.forOwn(n,function(e,t){if(!(r=A.deepEqual(e,i[t])))return!1}),r&&A.forOwn(i,function(e,t){if(!(r=A.deepEqual(e,n[t])))return!1})}return r},toJson:JSON.stringify,unset:function unset(e,t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(null==(e=e[t]))return;e[i]=void 0}},i=function(){function Component(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,Component),(e=_possibleConstructorReturn(this,_getPrototypeOf(Component).call(this))).debug=!!Object.hasOwnProperty.call(t,"debug")&&!!t.debug,Object.defineProperty(_assertThisInitialized(e),"_listeners",{value:{},writable:!0}),e}return _inherits(Component,x),Component}();A.logify(i.prototype),A.eventify(i.prototype,function(){return this._listeners},function(e){this._listeners=e});var u="Query",c="Index inaccessible after first operation",f={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},d=/([.*+?^=!:${}()|[\]/\\])/g,h=/%/g,p=/_/g,y=function(){function Query(e){var t;return _classCallCheck(this,Query),(t=_possibleConstructorReturn(this,_getPrototypeOf(Query).call(this))).collection=e,t.data=null,t}return _inherits(Query,i),_createClass(Query,[{key:"_applyWhereFromObject",value:function _applyWhereFromObject(e){var i=[],r=[],o=[];return A.forOwn(e,function(e,n){A.isObject(e)||(e={"==":e}),A.forOwn(e,function(e,t){i.push(n),r.push(t),o.push(e)})}),{fields:i,ops:r,predicates:o}}},{key:"_applyWhereFromArray",value:function _applyWhereFromArray(r){var o=this,a=[];return r.forEach(function(e,t){if(!A.isString(e)){var n=r[t-1],i=(A.isArray(e)?o._applyWhereFromArray:o._applyWhereFromObject).call(o,e);"or"===n&&(i.isOr=!0),a.push(i)}}),a.isArray=!0,a}},{key:"_testObjectGroup",value:function _testObjectGroup(e,t,n,i){var r,o=n.fields,a=n.ops,s=n.predicates,l=a.length;for(r=0;r<l;r++){var u=a[r],c="|"===u.charAt(0);u=c?u.substr(1):u;var f=this.evaluate(A.get(i,o[r]),u,s[r]);void 0!==f&&(e=t?f:c?e||f:e&&f),t=!1}return{keep:e,first:t}}},{key:"_testArrayGroup",value:function _testArrayGroup(e,t,n,i){var r,o=n.length;for(r=0;r<o;r++){var a=n[r],s=(a.isArray?this._testArrayGroup:this._testObjectGroup).call(this,!0,!0,a,i);e=n[r-1]?a.isOr?e||s.keep:e&&s.keep:s.keep,t=s.first}return{keep:e,first:t}}},{key:"between",value:function between(e,t,n){var i=2<arguments.length&&void 0!==n?n:{};if(this.data)throw A.err("".concat(u,"#between"))(500,"Cannot access index");return this.data=this.collection.getIndex(i.index).between(e,t,i),this}},{key:"compare",value:function compare(e,t,n,i){var r=e[t],o=A.get(n,r[0]),a=A.get(i,r[0]);if(o&&A.isString(o)&&(o=o.toUpperCase()),a&&A.isString(a)&&(a=a.toUpperCase()),void 0===n&&(n=null),void 0===i&&(i=null),"DESC"===r[1].toUpperCase()){var s=a;a=o,o=s}return o<a?-1:a<o?1:t<e.length-1?this.compare(e,t+1,n,i):0}},{key:"evaluate",value:function evaluate(e,t,n){var i=Query.ops;return i[t]?i[t](e,n):0===t.indexOf("like")?null!==this.like(n,t.substr(4)).exec(e):0===t.indexOf("notLike")?null===this.like(n,t.substr(7)).exec(e):void 0}},{key:"filter",value:function filter(e,t){var n=this;if(e=e||{},this.getData(),A.isObject(e)){var i,r={};(A.isObject(e.where)||A.isArray(e.where))&&(r=e.where),A.forOwn(e,function(e,t){t in f||t in r||(r[t]={"==":e})}),A.isObject(r)&&0!==Object.keys(r).length?i=this._applyWhereFromArray([r]):A.isArray(r)&&(i=this._applyWhereFromArray(r)),i&&(this.data=this.data.filter(function(e,t){return n._testArrayGroup(!0,!0,i,e).keep}));var o=e.orderBy||e.sort;if(A.isString(o)&&(o=[[o,"ASC"]]),A.isArray(o)||(o=null),o){o.forEach(function(e,t){A.isString(e)&&(o[t]=[e,"ASC"])}),this.data.sort(function(e,t){return n.compare(o,0,e,t)})}A.isNumber(e.skip)?this.skip(e.skip):A.isNumber(e.offset)&&this.skip(e.offset),A.isNumber(e.limit)&&this.limit(e.limit)}else A.isFunction(e)&&(this.data=this.data.filter(e,t));return this}},{key:"forEach",value:function forEach(e,t){return this.getData().forEach(e,t),this}},{key:"get",value:function get(e,t){var n=0<arguments.length&&void 0!==e?e:[],i=1<arguments.length&&void 0!==t?t:{};if(this.data)throw A.err("".concat(u,"#get"))(500,c);return n&&!A.isArray(n)&&(n=[n]),n.length?this.data=this.collection.getIndex(i.index).get(n):this.getData(),this}},{key:"getAll",value:function getAll(){var t=this,e={};if(this.data)throw A.err("".concat(u,"#getAll"))(500,c);for(var n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];if(!i.length||1===i.length&&A.isObject(i[0]))return this.getData(),this;i.length&&A.isObject(i[i.length-1])&&(e=i[i.length-1],i.pop());var o=this.collection.getIndex(e.index);return this.data=[],i.forEach(function(e){t.data=t.data.concat(o.get(e))}),this}},{key:"getData",value:function getData(){return this.data||(this.data=this.collection.index.getAll()),this.data}},{key:"like",value:function like(e,t){return new RegExp("^".concat(function escape(e){return e.replace(d,"\\$1")}(e).replace(h,".*").replace(p,"."),"$"),t)}},{key:"limit",value:function limit(e){if(!A.isNumber(e))throw A.err("".concat(u,"#limit"),"num")(400,"number",e);var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this}},{key:"map",value:function map(e,t){return this.data=this.getData().map(e,t),this}},{key:"mapCall",value:function mapCall(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return this.data=this.getData().map(function(e){return e[t].apply(e,n)}),this}},{key:"run",value:function run(){var e=this.data;return this.data=null,e}},{key:"skip",value:function skip(e){if(!A.isNumber(e))throw A.err("".concat(u,"#skip"),"num")(400,"number",e);var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this}}]),Query}();_defineProperty(y,"ops",{"=":function _(e,t){return e==t},"==":function _(e,t){return e==t},"===":function _(e,t){return e===t},"!=":function _(e,t){return e!=t},"!==":function _(e,t){return e!==t},">":function _(e,t){return t<e},">=":function _(e,t){return t<=e},"<":function _(e,t){return e<t},"<=":function _(e,t){return e<=t},isectEmpty:function isectEmpty(e,t){return!A.intersection(e||[],t||[]).length},isectNotEmpty:function isectNotEmpty(e,t){return A.intersection(e||[],t||[]).length},in:function _in(e,t){return-1!==t.indexOf(e)},notIn:function notIn(e,t){return-1===t.indexOf(e)},contains:function contains(e,t){return-1!==(e||[]).indexOf(t)},notContains:function notContains(e,t){return-1===(e||[]).indexOf(t)}});var O="belongsTo",C="hasMany",I="hasOne",g=function(){function Relation(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Relation),t.type=this.constructor.TYPE_NAME,this.validateOptions(e,t),"object"===_typeof(e)&&Object.defineProperty(this,"relatedMapper",{value:e}),Object.defineProperty(this,"inverse",{writable:!0}),A.fillIn(this,t)}return _createClass(Relation,[{key:"validateOptions",value:function validateOptions(e,t){var n="new ".concat("Relation"),i=t.localField;if(!i)throw A.err(n,"opts.localField")(400,"string",i);var r=t.foreignKey=t.foreignKey||t.localKey;if(!r&&(t.type===O||t.type===I))throw A.err(n,"opts.foreignKey")(400,"string",r);if(A.isString(e)){if(t.relation=e,!A.isFunction(t.getRelation))throw A.err(n,"opts.getRelation")(400,"function",t.getRelation)}else{if(!e)throw A.err(n,"related")(400,"Mapper or string",e);t.relation=e.name}}},{key:"assignTo",value:function assignTo(e){this.name=e.name,Object.defineProperty(this,"mapper",{value:e}),e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(this),e.relationFields.push(this.localField)}},{key:"canFindLinkFor",value:function canFindLinkFor(){return!(!this.foreignKey&&!this.localKey)}},{key:"getRelation",value:function getRelation(){return this.relatedMapper}},{key:"getForeignKey",value:function getForeignKey(e){return A.get(e,this.mapper.idAttribute)}},{key:"setForeignKey",value:function setForeignKey(e,t){e&&t&&this._setForeignKey(e,t)}},{key:"_setForeignKey",value:function _setForeignKey(t,e){var n=this,i=this.mapper.idAttribute;A.isArray(e)||(e=[e]),e.forEach(function(e){A.set(e,n.foreignKey,A.get(t,i))})}},{key:"getLocalField",value:function getLocalField(e){return A.get(e,this.localField)}},{key:"setLocalField",value:function setLocalField(e,t){return A.set(e,this.localField,t)}},{key:"getInverse",value:function getInverse(e){return this.inverse||this.findInverseRelation(e),this.inverse}},{key:"findInverseRelation",value:function findInverseRelation(t){var n=this;this.getRelation().relationList.forEach(function(e){if(e.getRelation()===t&&n.isInversedTo(e)&&n!==e)return n.inverse=e,!0})}},{key:"isInversedTo",value:function isInversedTo(e){return!e.foreignKey||e.foreignKey===this.foreignKey}},{key:"addLinkedRecords",value:function addLinkedRecords(e){var n=this,i=this.mapper.datastore;e.forEach(function(e){var t=n.getLocalField(e);(!(t=A.isFunction(n.add)?n.add(i,n,e):t&&n.linkRecord(e,t))||A.isArray(t)&&!t.length)&&n.canFindLinkFor(e)&&(t=n.findExistingLinksFor(e)),t&&n.setLocalField(e,t)})}},{key:"removeLinkedRecords",value:function removeLinkedRecords(e,t){var n=this.localField;t.forEach(function(e){A.set(e,n,void 0)})}},{key:"linkRecord",value:function linkRecord(e,t){var n=A.get(t,this.mapper.idAttribute);void 0===n?-1===this.relatedCollection.unsaved().indexOf(t)&&this.canAutoAddLinks&&(t=this.relatedCollection.add(t)):t!==this.relatedCollection.get(n)&&(this.setForeignKey(e,t),this.canAutoAddLinks&&(t=this.relatedCollection.add(t)));return t}},{key:"findExistingLinksByForeignKey",value:function findExistingLinksByForeignKey(e){if(null!=e)return this.relatedCollection.filter(_defineProperty({},this.foreignKey,e))}},{key:"ensureLinkedDataHasProperType",value:function ensureLinkedDataHasProperType(e,t){var n=this.getRelation(),i=this.getLocalField(e);A.isArray(i)&&(!i.length||n.is(i[0]))||!i||n.is(i)||A.set(e,this.localField,n.createRecord(i,t))}},{key:"isRequiresParentId",value:function isRequiresParentId(){return!1}},{key:"isRequiresChildId",value:function isRequiresChildId(){return!1}},{key:"createChildRecord",value:function createChildRecord(t,e,n){var i=this;return this.setForeignKey(t,e),this.createLinked(e,n).then(function(e){i.setLocalField(t,e)})}},{key:"createLinked",value:function createLinked(e,t){var n=A.isArray(e)?"createMany":"create";return this.getRelation()[n](e,t)}},{key:"canAutoAddLinks",get:function get(){return void 0===this.add||!!this.add}},{key:"relatedCollection",get:function get(){return this.mapper.datastore.getCollection(this.relation)}}]),Relation}(),m=function(){function BelongsToRelation(){return _classCallCheck(this,BelongsToRelation),_possibleConstructorReturn(this,_getPrototypeOf(BelongsToRelation).apply(this,arguments))}return _inherits(BelongsToRelation,g),_createClass(BelongsToRelation,[{key:"getForeignKey",value:function getForeignKey(e){return A.get(e,this.foreignKey)}},{key:"_setForeignKey",value:function _setForeignKey(e,t){A.set(e,this.foreignKey,A.get(t,this.getRelation().idAttribute))}},{key:"findExistingLinksFor",value:function findExistingLinksFor(e){if(e){var t=A.get(e,this.foreignKey);return null!=t?this.relatedCollection.get(t):void 0}}},{key:"isRequiresParentId",value:function isRequiresParentId(){return!0}},{key:"createParentRecord",value:function createParentRecord(t,e){var n=this,i=this.getLocalField(t);return this.createLinked(i,e).then(function(e){n.setForeignKey(t,e)})}},{key:"createChildRecord",value:function createChildRecord(){throw new Error('"BelongsTo" relation does not support child creation as it cannot have children.')}}]),BelongsToRelation}();_defineProperty(m,"TYPE_NAME","belongsTo");var k=function(){function HasManyRelation(){return _classCallCheck(this,HasManyRelation),_possibleConstructorReturn(this,_getPrototypeOf(HasManyRelation).apply(this,arguments))}return _inherits(HasManyRelation,g),_createClass(HasManyRelation,[{key:"validateOptions",value:function validateOptions(e,t){_get(_getPrototypeOf(HasManyRelation.prototype),"validateOptions",this).call(this,e,t);var n=t.localKeys,i=t.foreignKeys,r=t.foreignKey;if(!r&&!n&&!i)throw A.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",r)}},{key:"canFindLinkFor",value:function canFindLinkFor(e){return!!(this.foreignKey||this.foreignKeys||this.localKeys&&A.get(e,this.localKeys))}},{key:"linkRecord",value:function linkRecord(n,e){var i=this,r=this.relatedCollection,o=this.canAutoAddLinks,a=this.foreignKey,s=this.relatedCollection.unsaved();return e.map(function(e){var t=r.recordId(e);return(void 0===t&&-1===s.indexOf(e)||e!==r.get(t))&&(a&&i.setForeignKey(n,e),o&&(e=r.add(e))),e})}},{key:"findExistingLinksFor",value:function findExistingLinksFor(e){var t,n=A.get(e,this.mapper.idAttribute),i=this.localKeys?A.get(e,this.localKeys):null;if(void 0!==n&&this.foreignKey?t=this.findExistingLinksByForeignKey(n):this.localKeys&&i?t=this.findExistingLinksByLocalKeys(i):void 0!==n&&this.foreignKeys&&(t=this.findExistingLinksByForeignKeys(n)),t&&t.length)return t}},{key:"findExistingLinksByLocalKeys",value:function findExistingLinksByLocalKeys(e){return this.relatedCollection.filter({where:_defineProperty({},this.relatedCollection.mapper.idAttribute,{in:e})})}},{key:"findExistingLinksByForeignKeys",value:function findExistingLinksByForeignKeys(e){return this.relatedCollection.filter({where:_defineProperty({},this.foreignKeys,{contains:e})})}},{key:"isRequiresParentId",value:function isRequiresParentId(){return!!this.localKeys&&0<this.localKeys.length}},{key:"isRequiresChildId",value:function isRequiresChildId(){return!!this.foreignKey}},{key:"createParentRecord",value:function createParentRecord(t,e){var n=this,i=this.getLocalField(t),r=this.getRelation().idAttribute;return this.createLinked(i,e).then(function(e){A.set(t,n.localKeys,e.map(function(e){return A.get(e,r)}))})}},{key:"createLinked",value:function createLinked(e,t){return this.getRelation().createMany(e,t)}}]),HasManyRelation}();_defineProperty(k,"TYPE_NAME","hasMany");var b=function(){function HasOneRelation(){return _classCallCheck(this,HasOneRelation),_possibleConstructorReturn(this,_getPrototypeOf(HasOneRelation).apply(this,arguments))}return _inherits(HasOneRelation,g),_createClass(HasOneRelation,[{key:"findExistingLinksFor",value:function findExistingLinksFor(e,t){var n=A.get(t,e.idAttribute),i=this.findExistingLinksByForeignKey(n);if(i&&i.length)return i[0]}},{key:"isRequiresChildId",value:function isRequiresChildId(){return!0}}]),HasOneRelation}();_defineProperty(b,"TYPE_NAME","hasOne"),[m,k,b].forEach(function(n){g[n.TYPE_NAME]=function(e,t){return new n(e,t)}});function P(t,n){return function(e){g.belongsTo(t,n).assignTo(e)}}function Q(t,n){return function(e){g.hasMany(t,n).assignTo(e)}}function R(t,n){return function(e){g.hasOne(t,n).assignTo(e)}}function T(i,r){var o=i.datastore;return o&&o[r]?function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[r].apply(o,[i.name].concat(t))}:i[r].bind(i)}var S="creating",F="noValidate",E="keepChangeHistory",j="previous",M=function(){function Record(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Record);var i=(e=_possibleConstructorReturn(this,_getPrototypeOf(Record).call(this)))._set,r=e.constructor.mapper;i(S,!0),i(F,!!n.noValidate),i(E,void 0===n.keepChangeHistory?!r||r.keepChangeHistory:n.keepChangeHistory);var o=r?A.get(t,r.idAttribute):void 0;return void 0!==o&&A.set(_assertThisInitialized(e),r.idAttribute,o),A.fillIn(_assertThisInitialized(e),t),i(S,!1),void 0!==n.validateOnSet?i(F,!n.validateOnSet):r&&void 0!==r.validateOnSet?i(F,!r.validateOnSet):i(F,!1),i(j,r?r.toJSON(t):A.plainCopy(t)),e}return _inherits(Record,x),_createClass(Record,[{key:"_mapper",value:function _mapper(){var e=this.constructor.mapper;if(!e)throw A.err("".concat("Record","#_mapper"),"")(404,"mapper");return e}},{key:"afterLoadRelations",value:function afterLoadRelations(){}},{key:"beforeLoadRelations",value:function beforeLoadRelations(){}},{key:"changeHistory",value:function changeHistory(){return(this._get("history")||[]).slice()}},{key:"changes",value:function changes(e){var t=0<arguments.length&&void 0!==e?e:{};return A.diffObjects("function"==typeof this.toJSON?this.toJSON(t):this,this._get("previous"),t)}},{key:"commit",value:function commit(e){this._set("changed"),this._set("changing",!1),this._set("history",[]),this._set("previous",this.toJSON(e))}},{key:"destroy",value:function destroy(e){var t=0<arguments.length&&void 0!==e?e:{},n=this._mapper();return T(n,"destroy")(A.get(this,n.idAttribute),t)}},{key:"get",value:function get(e){return A.get(this,e)}},{key:"hasChanges",value:function hasChanges(e){return!!(this._get("changed")||[]).length||A.areDifferent("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)}},{key:"isNew",value:function isNew(){return void 0===A.get(this,this._mapper().idAttribute)}},{key:"isValid",value:function isValid(e){return!this._mapper().validate(this,e)}},{key:"removeInverseRelation",value:function removeInverseRelation(e,t,n,i){var r=this;if(n.type===I)w(e,n.localField,void 0);else if(n.type===C){var o=A.get(e,n.localField);void 0===t?A.remove(o,function(e){return e===r}):A.remove(o,function(e){return e===r||t===A.get(e,i)})}}},{key:"setupInverseRelation",value:function setupInverseRelation(e,t,n,i){var r=this;if(n.type===I)w(e,n.localField,this);else if(n.type===C){var o=A.get(e,n.localField);void 0===t?A.noDupeAdd(o,this,function(e){return e===r}):A.noDupeAdd(o,this,function(e){return e===r||t===A.get(e,i)})}}},{key:"loadRelations",value:function loadRelations(e,t){var n,a=this,s=1<arguments.length&&void 0!==t?t:{},l=this._mapper();return e=e||[],A.isString(e)&&(e=[e]),s.with=e,A._(s,l),s.adapter=l.getAdapterName(s),n=s.op="beforeLoadRelations",A.resolve(this[n](e,s)).then(function(){n=s.op="loadRelations",l.dbg(n,a,e,s);var r,o=[];return A.forEachRelation(l,s,function(t,e){var n=t.getRelation();if(e.raw=!1,A.isFunction(t.load))r=t.load(l,t,a,s);else if("hasMany"===t.type||"hasOne"===t.type)t.foreignKey?r=T(n,"findAll")(_defineProperty({},t.foreignKey,A.get(a,l.idAttribute)),e).then(function(e){return"hasOne"===t.type?e.length?e[0]:void 0:e}):t.localKeys?r=T(n,"findAll")({where:_defineProperty({},n.idAttribute,{in:A.get(a,t.localKeys)})}):t.foreignKeys&&(r=T(n,"findAll")({where:_defineProperty({},t.foreignKeys,{contains:A.get(a,l.idAttribute)})},s));else if("belongsTo"===t.type){var i=A.get(a,t.foreignKey);A.isSorN(i)&&(r=T(n,"find")(i,e))}r&&(r=r.then(function(e){t.setLocalField(a,e)}),o.push(r))}),Promise.all(o)}).then(function(){return n=s.op="afterLoadRelations",A.resolve(a[n](e,s)).then(function(){return a})})}},{key:"previous",value:function previous(e){return e?this._get("previous.".concat(e)):this._get("previous")}},{key:"revert",value:function revert(e){var n=this,i=0<arguments.length&&void 0!==e?e:{},r=this._get("previous");i.preserve||(i.preserve=[]),A.forOwn(this,function(e,t){t!==n._mapper().idAttribute&&!Object.hasOwnProperty.call(r,t)&&Object.hasOwnProperty.call(n,t)&&-1===i.preserve.indexOf(t)&&delete n[t]}),A.forOwn(r,function(e,t){-1===i.preserve.indexOf(t)&&(n[t]=e)}),this.commit()}},{key:"save",value:function save(e){function xl(e){var t=i.raw?e.data:e;return t&&(A.deepMixIn(n,t),n.commit()),e}var n=this,i=0<arguments.length&&void 0!==e?e:{},t=this._mapper(),r=A.get(this,t.idAttribute),o=this;if(void 0===r)return T(t,"create")(o,i).then(xl);if(i.changesOnly){var a=this.changes(i);o={},A.fillIn(o,a.added),A.fillIn(o,a.changed)}return T(t,"update")(r,o,i).then(xl)}},{key:"set",value:function set(e,t,n){var i=2<arguments.length&&void 0!==n?n:{};A.isObject(e)&&(i=t||{}),i.silent&&this._set("silent",!0),A.set(this,e,t),this._get("eventId")||this._set("silent")}},{key:"toJSON",value:function toJSON(e){var t=this.constructor.mapper;if(t)return t.toJSON(this,e);var n={};return A.forOwn(this,function(e,t){n[t]=A.plainCopy(e)}),n}},{key:"unset",value:function unset(e,t){this.set(e,void 0,t)}},{key:"validate",value:function validate(e){return this._mapper().validate(this,e)}}]),Record}();function insertAt(e,t,n){return e.splice(t,0,n),e}function removeAt(e,t){return e.splice(t,1),e}function binarySearch(e,t,n){for(var i,r,o,a,s,l=0,u=e.length;l<u;){if(o=t,a=e[r=(l+u)/2|0],s=n,0==(i=o===a?0:(s&&(o=s(o),a=s(a)),null===o&&null===a||void 0===o&&void 0===a||null==o?-1:null==a?1:o<a?-1:a<o?1:0)))return{found:!0,index:r};i<0?u=r:l=1+r}return{found:!1,index:u}}_defineProperty(M,"creatingPath",S),_defineProperty(M,"noValidatePath",F),_defineProperty(M,"keepChangeHistoryPath",E),_defineProperty(M,"previousPath",j),A.eventify(M.prototype,function(){return this._get("events")},function(e){this._set("events",e)});function fa(e,t){var n="";return e&&(A.isNumber(e)?n+="[".concat(e,"]"):n+=t?".".concat(e):"".concat(e)),n}function ha(e,t,n){return{expected:t,actual:""+e,path:function makePath(e){var t=0<arguments.length&&void 0!==e?e:{},n="";return(t.path||[]).forEach(function(e){n+=fa(e,n)}),n+=fa(t.prop,n)}(n)}}function ia(e,t,n,i){i.push(ha(e,t,n))}function ja(e,t,n,i){var r=n[e];if(t.length>r)return ha(t.length,"length no more than ".concat(r),i)}function ka(e,t,n,i){var r=n[e];if(t.length<r)return ha(t.length,"length no less than ".concat(r),i)}function ma(e,t,n,i){var r=[];return e.forEach(function(e){void 0!==n[e]&&(r=r.concat(J[e](t,n,i)||[]))}),r.length?r:void 0}var L=function(){function Index(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(_classCallCheck(this,Index),!A.isArray(e))throw new Error("fieldList must be an array.");this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}return _createClass(Index,[{key:"set",value:function set(e,t){A.isArray(e)||(e=[e]);var n=e.shift()||void 0,i=binarySearch(this.keys,n);if(0===e.length)if(i.found){var r=binarySearch(this.values[i.index],t,this.hashCode);r.found||insertAt(this.values[i.index],r.index,t)}else insertAt(this.keys,i.index,n),insertAt(this.values,i.index,[t]);else if(i.found)this.values[i.index].set(e,t);else{insertAt(this.keys,i.index,n);var o=new Index([],{hashCode:this.hashCode});o.set(e,t),insertAt(this.values,i.index,o)}}},{key:"get",value:function get(e){A.isArray(e)||(e=[e]);var t=e.shift()||void 0,n=binarySearch(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index].slice():[]:n.found?this.values[n.index].get(e):[]}},{key:"getAll",value:function getAll(e){var t=0<arguments.length&&void 0!==e?e:{},n=[],i=this.values;if("desc"===t.order)for(var r=i.length-1;0<=r;r--){var o=i[r];n=o.isIndex?n.concat(o.getAll(t)):n.concat(o)}else for(var a=0;a<i.length;a++){var s=i[a];n=s.isIndex?n.concat(s.getAll(t)):n.concat(s)}return n}},{key:"visitAll",value:function visitAll(t,n){this.values.forEach(function(e){e.isIndex?e.visitAll(t,n):e.forEach(t,n)})}},{key:"between",value:function between(e,t,n){var i=2<arguments.length&&void 0!==n?n:{};A.isArray(e)||(e=[e]),A.isArray(t)||(t=[t]),A.fillIn(i,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var r=this._between(e,t,i);return i.limit?r.slice(i.offset,i.limit+i.offset):r.slice(i.offset)}},{key:"_between",value:function _between(e,t,n){var i,r=[],o=e.shift(),a=t.shift();if(i=void 0!==o?binarySearch(this.keys,o):{found:!1,index:0},0===e.length){i.found&&!1===n.leftInclusive&&(i.index+=1);for(var s=i.index;s<this.keys.length;s+=1){if(void 0!==a)if(n.rightInclusive){if(this.keys[s]>a)break}else if(this.keys[s]>=a)break;if(r=this.values[s].isIndex?r.concat(this.values[s].getAll()):r.concat(this.values[s]),n.limit&&r.length>=n.limit+n.offset)break}}else for(var l=i.index;l<this.keys.length;l+=1){var u=this.keys[l];if(a<u)break;if(r=this.values[l].isIndex?u===o?r.concat(this.values[l]._between(A.copy(e),t.map(function(){}),n)):u===a?r.concat(this.values[l]._between(e.map(function(){}),A.copy(t),n)):r.concat(this.values[l].getAll()):r.concat(this.values[l]),n.limit&&r.length>=n.limit+n.offset)break}return n.limit?r.slice(0,n.limit+n.offset):r}},{key:"peek",value:function peek(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]}},{key:"clear",value:function clear(){this.keys=[],this.values=[]}},{key:"insertRecord",value:function insertRecord(t){var e=this.fieldList.map(function(e){return A.isFunction(e)?e(t)||void 0:t[e]||void 0});this.set(e,t)}},{key:"removeRecord",value:function removeRecord(r){var o,a=this,s=void 0!==this.hashCode(r);return this.values.forEach(function(e,t){if(e.isIndex){if(e.removeRecord(r))return 0===e.keys.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}else{var n={};if(void 0!==a.keys[t]&&s)s&&(n=binarySearch(e,r,a.hashCode));else for(var i=e.length-1;0<=i;i--)if(e[i]===r){n={found:!0,index:i};break}if(n.found)return removeAt(e,n.index),0===e.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}}),o?r:void 0}},{key:"updateRecord",value:function updateRecord(e){void 0!==this.removeRecord(e)&&this.insertRecord(e)}}]),Index}(),K=M.noValidatePath,D="Collection",N={commitOnMerge:!0,emitRecordEvents:!0,idAttribute:"id",onConflict:"merge"},q=function(){function Collection(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Collection),t=_possibleConstructorReturn(this,_getPrototypeOf(Collection).call(this,n)),e&&!A.isArray(e)&&(n=e,e=[]),A.isString(n)&&(n={idAttribute:n}),e=e||[],Object.defineProperties(_assertThisInitialized(t),{mapper:{value:void 0,writable:!0},queryClass:{value:void 0,writable:!0}}),A.fillIn(_assertThisInitialized(t),n),A.fillIn(_assertThisInitialized(t),A.copy(N)),t.queryClass||(t.queryClass=y);var i=t.recordId();return Object.defineProperties(_assertThisInitialized(t),{index:{value:new L([i],{hashCode:function hashCode(e){return A.get(e,i)}})},indexes:{value:{}}}),(A.isObject(e)||A.isArray(e)&&e.length)&&t.add(e),t}return _inherits(Collection,i),_createClass(Collection,[{key:"_onRecordEvent",value:function _onRecordEvent(){this.emitRecordEvents&&this.emit.apply(this,arguments)}},{key:"add",value:function add(e,t){var o=this,a=1<arguments.length&&void 0!==t?t:{};A._(a,this),e=this.beforeAdd(e,a)||e;var n=!1,s=this.recordId();if(!A.isArray(e)){if(!A.isObject(e))throw A.err("".concat(D,"#add"),"records")(400,"object or array",e);e=[e],n=!0}e=e.map(function(n){var e=o.recordId(n),i=void 0===e?e:o.get(e);if(n===i)return i;if(i){var t=a.onConflict||o.onConflict;if("merge"!==t&&"replace"!==t&&"skip"!==t)throw A.err("".concat(D,"#add"),"opts.onConflict")(400,"one of (merge, replace, skip)",t,!0);var r=i._get(K);a.noValidate&&i._set(K,!0),"merge"===t?A.deepMixIn(i,n):"replace"===t&&(A.forOwn(i,function(e,t){t!==s&&void 0===n[t]&&(i[t]=void 0)}),i.set(n)),a.noValidate&&i._set(K,r),n=i,a.commitOnMerge&&A.isFunction(n.commit)&&n.commit(),o.updateIndexes(n)}else n=o.mapper?o.mapper.createRecord(n,a):n,o.index.insertRecord(n),A.forOwn(o.indexes,function(e,t){e.insertRecord(n)}),n&&A.isFunction(n.on)&&n.on("all",o._onRecordEvent,o);return n});var i=n?e[0]:e;return a.silent||this.emit("add",i),this.afterAdd(e,a,i)||i}},{key:"afterAdd",value:function afterAdd(){}},{key:"afterRemove",value:function afterRemove(){}},{key:"afterRemoveAll",value:function afterRemoveAll(){}},{key:"beforeAdd",value:function beforeAdd(){}},{key:"beforeRemove",value:function beforeRemove(){}},{key:"beforeRemoveAll",value:function beforeRemoveAll(){}},{key:"between",value:function between(e,t,n){return this.query().between(e,t,n).run()}},{key:"createIndex",value:function createIndex(e,t,n){var i=this,r=2<arguments.length&&void 0!==n?n:{};A.isString(e)&&void 0===t&&(t=[e]),r.hashCode||(r.hashCode=function(e){return i.recordId(e)});var o=this.indexes[e]=new L(t,r);this.index.visitAll(o.insertRecord,o)}},{key:"filter",value:function filter(e,t){return this.query().filter(e,t).run()}},{key:"forEach",value:function forEach(e,t){this.index.visitAll(e,t)}},{key:"get",value:function get(e){var t=void 0===e?[]:this.query().get(e).run();return t.length?t[0]:void 0}},{key:"getAll",value:function getAll(){var e;return(e=this.query()).getAll.apply(e,arguments).run()}},{key:"getIndex",value:function getIndex(e){var t=e?this.indexes[e]:this.index;if(!t)throw A.err("".concat(D,"#getIndex"),e)(404,"index");return t}},{key:"limit",value:function limit(e){return this.query().limit(e).run()}},{key:"map",value:function map(t,n){var i=[];return this.index.visitAll(function(e){i.push(t.call(n,e))}),i}},{key:"mapCall",value:function mapCall(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];var r=[];return this.index.visitAll(function(e){r.push(e[t].apply(e,n))}),r}},{key:"prune",value:function prune(e){return this.removeAll(this.unsaved(),e)}},{key:"query",value:function query(){return new this.queryClass(this)}},{key:"recordId",value:function recordId(e){return e?A.get(e,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute}},{key:"reduce",value:function reduce(e,t){return this.getAll().reduce(e,t)}},{key:"remove",value:function remove(e,t){var n=1<arguments.length&&void 0!==t?t:{};this.beforeRemove(e,n);var i=A.isSorN(e)?this.get(e):e;return A.isObject(i)&&(i=this.index.removeRecord(i))&&(A.forOwn(this.indexes,function(e,t){e.removeRecord(i)}),A.isFunction(i.off)&&i.off("all",this._onRecordEvent,this),n.silent||this.emit("remove",i)),this.afterRemove(e,n,i)||i}},{key:"removeAll",value:function removeAll(e,t){var n=this,i=1<arguments.length&&void 0!==t?t:{};this.beforeRemoveAll(e,i);var r=A.isArray(e)?e.slice():this.filter(e),o=A.plainCopy(i);return o.silent=!0,r=r.map(function(e){return n.remove(e,o)}).filter(function(e){return e}),i.silent||this.emit("remove",r),this.afterRemoveAll(e,i,r)||r}},{key:"skip",value:function skip(e){return this.query().skip(e).run()}},{key:"toJSON",value:function toJSON(e){return this.mapCall("toJSON",e)}},{key:"unsaved",value:function unsaved(){return this.index.get()}},{key:"updateIndex",value:function updateIndex(e,t){var n=1<arguments.length&&void 0!==t?t:{};this.getIndex(n.index).updateRecord(e)}},{key:"updateIndexes",value:function updateIndexes(n){this.index.updateRecord(n),A.forOwn(this.indexes,function(e,t){e.updateRecord(n)})}}]),Collection}(),z={array:A.isArray,boolean:A.isBoolean,integer:A.isInteger,null:A.isNull,number:A.isNumber,object:A.isObject,string:A.isString},J={allOf:function allOf(t,e,n){var i=[];return e.allOf.forEach(function(e){i=i.concat(G(t,e,n)||[])}),i.length?i:void 0},anyOf:function anyOf(n,e,i){var r=!1,o=[];return e.anyOf.forEach(function(e){var t=G(n,e,i);t?o=o.concat(t):r=!0}),r?void 0:o},dependencies:function dependencies(){},enum:function _enum(t,e,n){var i=e.enum;if(-1===A.findIndex(i,function(e){return A.deepEqual(e,t)}))return ha(t,"one of (".concat(i.join(", "),")"),n)},items:function items(e,t){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},items=t.items,i=[],r=A.isArray(items),o=e.length,a=0;a<o;a++)r&&(items=t.items[a]),n.prop=a,i=i.concat(G(e[a],items,n)||[]);return i.length?i:void 0},maximum:function maximum(e,t,n){var maximum=t.maximum,i=t.exclusiveMaximum;if(_typeof(e)===_typeof(maximum)&&!(i?e<maximum:e<=maximum))return ha(e,i?"no more than nor equal to ".concat(maximum):"no more than ".concat(maximum),n)},maxItems:function maxItems(e,t,n){if(A.isArray(e))return ja("maxItems",e,t,n)},maxLength:function maxLength(e,t,n){return ja("maxLength",e,t,n)},maxProperties:function maxProperties(e,t,n){if(A.isObject(e)){var maxProperties=t.maxProperties,i=Object.keys(e).length;return maxProperties<i?ha(i,"no more than ".concat(maxProperties," properties"),n):void 0}},minimum:function minimum(e,t,n){var minimum=t.minimum,i=t.exclusiveMinimum;if(_typeof(e)===_typeof(minimum)&&!(i?minimum<e:minimum<=e))return ha(e,i?"no less than nor equal to ".concat(minimum):"no less than ".concat(minimum),n)},minItems:function minItems(e,t,n){if(A.isArray(e))return ka("minItems",e,t,n)},minLength:function minLength(e,t,n){return ka("minLength",e,t,n)},minProperties:function minProperties(e,t,n){if(A.isObject(e)){var minProperties=t.minProperties,i=Object.keys(e).length;return i<minProperties?ha(i,"no more than ".concat(minProperties," properties"),n):void 0}},multipleOf:function multipleOf(e,t,n){var multipleOf=t.multipleOf;if(A.isNumber(e)&&e/multipleOf%1!=0)return ha(e,"multipleOf ".concat(multipleOf),n)},not:function not(e,t,n){if(!G(e,t.not,n))return ha("succeeded","should have failed",n)},oneOf:function oneOf(n,e,i){var r=!1,o=[];return e.oneOf.forEach(function(e){var t=G(n,e,i);if(t)o=o.concat(t);else{if(r)return o=[ha("valid against more than one","valid against only one",i)],r=!1;r=!0}}),r?void 0:o},pattern:function pattern(e,t,n){var pattern=t.pattern;if(A.isString(e)&&!e.match(pattern))return ha(e,pattern,n)},properties:function properties(r,e){var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(!A.isArray(r)){var t=void 0===e.additionalProperties||e.additionalProperties,a=[],properties=e.properties||{},n=e.patternProperties||{},s=[];A.forOwn(properties,function(e,t){o.prop=t,s=s.concat(G(r[t],e,o)||[]),a.push(t)});var l=A.omit(r,a);A.forOwn(n,function(n,i){A.forOwn(l,function(e,t){t.match(i)&&(o.prop=t,s=s.concat(G(r[t],n,o)||[]),a.push(t))})});var i=Object.keys(A.omit(r,a));if(!1===t){if(i.length){var u=o.prop;o.prop="",ia("extra fields: ".concat(i.join(", ")),"no extra fields",o,s),o.prop=u}}else A.isObject(t)&&i.forEach(function(e){o.prop=e,s=s.concat(G(r[e],t,o)||[])});return s.length?s:void 0}},required:function required(n,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},required=e.required,r=[];return i.existingOnly||required.forEach(function(e){if(void 0===A.get(n,e)){var t=i.prop;i.prop=e,ia(void 0,"a value",i,r),i.prop=t}}),r.length?r:void 0},type:function type(t,n,i){var r,type=n.type;if(A.isString(type)&&(type=[type]),type.forEach(function(e){if(z[e](t,n,i))return r=e,!1}),!r)return ha(null!=t?_typeof(t):""+t,"one of (".concat(type.join(", "),")"),i);var e=ee[r];return e?e(t,n,i):void 0},uniqueItems:function uniqueItems(e,t,n){var i,r,o;if(e&&e.length&&t.uniqueItems)for(r=e.length-1;0<r;r--)for(i=e[r],o=r-1;0<=o;o--)if(A.deepEqual(i,e[o]))return ha(i,"no duplicates",n)}},B=["enum","type","allOf","anyOf","oneOf","not"],H=["items","maxItems","minItems","uniqueItems"],U=["multipleOf","maximum","minimum"],V=["maxProperties","minProperties","required","properties","dependencies"],$=["maxLength","minLength","pattern"],G=function validate(e,t,n){var i,r=2<arguments.length&&void 0!==n?n:{},o=[];r.ctx||(r.ctx={value:e,schema:t});var a=r.prop;if(void 0!==t){if(!A.isObject(t))throw A.err("".concat("Schema","#validate"))(500,'Invalid schema at path: "'.concat(r.path,'"'));return(void 0===r.path&&(r.path=[]),void 0!==r.prop&&(i=!0,r.path.push(r.prop),r.prop=void 0),t.extends&&(o=A.isFunction(t.extends.validate)?o.concat(t.extends.validate(e,r)||[]):o.concat(G(e,t.extends,r)||[])),void 0===e)?(!0!==t.required||r.existingOnly||ia(e,"a value",r,o),i&&(r.path.pop(),r.prop=a),o.length?o:void 0):(o=o.concat(function validateAny(e,t,n){return ma(B,e,t,n)}(e,t,r)||[]),i&&(r.path.pop(),r.prop=a),o.length?o:void 0)}},W="changing",Y="changed",X="history",Z="eventId",ee={array:function array(e,t,n){return ma(H,e,t,n)},integer:function integer(e,t,n){return ee.numeric(e,t,n)},number:function number(e,t,n){return ee.numeric(e,t,n)},numeric:function numeric(e,t,n){return ma(U,e,t,n)},object:function object(e,t,n){return ma(V,e,t,n)},string:function string(e,t,n){return ma($,e,t,n)}},te=function(){function Schema(e){var i;return _classCallCheck(this,Schema),i=_possibleConstructorReturn(this,_getPrototypeOf(Schema).call(this)),e=e||{},A.fillIn(_assertThisInitialized(i),e),"object"===i.type?(i.properties=i.properties||{},A.forOwn(i.properties,function(e,t){e instanceof Schema||(i.properties[t]=new Schema(e))})):"array"!==i.type||!i.items||i.items instanceof Schema||(i.items=new Schema(i.items)),!i.extends||i.extends instanceof Schema||(i.extends=new Schema(i.extends)),["allOf","anyOf","oneOf"].forEach(function(n){i[n]&&i[n].forEach(function(e,t){e instanceof Schema||(i[n][t]=new Schema(e))})}),i}return _inherits(Schema,i),_createClass(Schema,[{key:"apply",value:function apply(n,e){var i=this,r=1<arguments.length&&void 0!==e?e:{};r.getter||(r.getter="_get"),r.setter||(r.setter="_set"),r.unsetter||(r.unsetter="_unset"),r.track||(r.track=this.track);var t=this.properties||{};A.forOwn(t,function(e,t){Object.defineProperty(n,t,i.makeDescriptor(t,e,r))})}},{key:"applyDefaults",value:function applyDefaults(i){if(i){var e=this.properties||{},r=A.isFunction(i.set)||A.isFunction(i._set);A.forOwn(e,function(e,t){if(Object.hasOwnProperty.call(e,"default")&&void 0===A.get(i,t)&&(r?i.set(t,A.plainCopy(e.default),{silent:!0}):A.set(i,t,A.plainCopy(e.default))),"object"===e.type&&e.properties){if(r){var n=i._get("noValidate");i._set("noValidate",!0),A.set(i,t,A.get(i,t)||{},{silent:!0}),i._set("noValidate",n)}else A.set(i,t,A.get(i,t)||{});e.applyDefaults(A.get(i,t))}})}}},{key:"makeDescriptor",value:function makeDescriptor(d,h,e){var t={configurable:!0,enumerable:void 0===h.enumerable||!!h.enumerable},p="props.".concat(d),v="previous.".concat(d),y=e.getter,g=e.setter,m=e.unsetter,_=A.isBoolean(e.track)?e.track:h.track;if(t.get=function(){return this._get(p)},A.isFunction(h.get)){var n=t.get;t.get=function(){return h.get.call(this,n)}}if(t.set=function(r){var o=this,a=this[y],s=this[g],l=this[m];if(!a("noValidate")){var e=h.validate(r,{path:[d]});if(e){var t=new Error("validation failed");throw t.errors=e,t}}if(_&&!a("creating")){var n=a(v),u=a(p),i=a(W),c=a(Y);i||(c=[]);var f=c.indexOf(d);u!==r&&-1===f&&c.push(d),n===r&&0<=f&&c.splice(f,1),c.length||(i=!1,l(W),l(Y),a(Z)&&(clearTimeout(a(Z)),l(Z))),!i&&c.length&&(s(Y,c),s(W,!0),s(Z,setTimeout(function(){if(l(Y),l(Z),l(W),!a("silent")){var e;for(e=0;e<c.length;e++)o.emit("change:"+c[e],o,A.get(o,c[e]));var t=A.diffObjects(_defineProperty({},d,r),_defineProperty({},d,u));if(a("keepChangeHistory")){var n=A.plainCopy(t);n.timestamp=(new Date).getTime();var i=a(X);i||s(X,i=[]),i.push(n)}o.emit("change",o,t)}l("silent")},0)))}return s(p,r),r},A.isFunction(h.set)){var i=t.set;t.set=function(e){return h.set.call(this,e,i)}}return t}},{key:"pick",value:function pick(n){var i=this;if(void 0!==n){if("object"!==this.type)return"array"===this.type?n.map(function(e){var t=i.items?i.items.pick(e):{};return i.extends&&A.fillIn(t,i.extends.pick(e)),t}):A.plainCopy(n);var r={},e=this.properties;if(e&&A.forOwn(e,function(e,t){r[t]=e.pick(n[t])}),this.extends&&A.fillIn(r,this.extends.pick(n)),this.additionalProperties)for(var t in n)e[t]||(r[t]=A.plainCopy(n[t]));return r}}},{key:"validate",value:function validate(e,t){return G(e,this,t)}}]),Schema}();_defineProperty(te,"ANY_OPS",B),_defineProperty(te,"ARRAY_OPS",H),_defineProperty(te,"NUMERIC_OPS",U),_defineProperty(te,"OBJECT_OPS",V),_defineProperty(te,"STRING_OPS",$),_defineProperty(te,"typeGroupValidators",ee),_defineProperty(te,"types",z),_defineProperty(te,"validate",G),_defineProperty(te,"validationKeywords",J);function Ia(f){return function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=n[n.length-f],o=r.op;if(this.dbg.apply(this,[o].concat(n)),-1!==ie.indexOf(o)&&!1!==r.applyDefaults){var a=this.getSchema();if(a&&a.applyDefaults){var s=n[0];A.isArray(s)||(s=[s]),s.forEach(function(e){a.applyDefaults(e)})}}if(-1!==re.indexOf(o)&&!r.noValidate){var l=r.existingOnly;0===o.indexOf("beforeUpdate")&&void 0===r.existingOnly&&(r.existingOnly=!0);var u=this.validate(n["beforeUpdate"===o?1:0],A.pick(r,["existingOnly"]));if(r.existingOnly=l,u){var c=new Error("validation failed");return c.errors=u,A.reject(c)}}(r.notify||void 0===r.notify&&this.notify)&&setTimeout(function(){e.emit.apply(e,[o].concat(n))})}}function Ua(e,t,n){var i=this._completedQueries[e][t];return A.isFunction(i)?i(e,t,n):i}var ne="Mapper",ie=["beforeCreate","beforeCreateMany"],re=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"],oe=Ia(1),ae=Ia(2),se={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function adapterArgs(e,t,n,i){return[t,e.toJSON(n,i),i]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function adapterArgs(e,t,n,i){return[e.toJSON(t,i),n,i]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function adapterArgs(t,e,n){return[e.map(function(e){return t.toJSON(e,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},le={_adapters:{},applyDefaults:!0,applySchema:!0,defaultAdapter:"http",idAttribute:"id",keepChangeHistory:!0,notify:!0,noValidate:!1,raw:!1,validateOnSet:!0},ue=function(){function Mapper(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(_classCallCheck(this,Mapper),_defineProperty(_assertThisInitialized(e=_possibleConstructorReturn(this,_getPrototypeOf(Mapper).call(this))),"afterCount",ae),_defineProperty(_assertThisInitialized(e),"afterCreate",ae),_defineProperty(_assertThisInitialized(e),"afterCreateMany",ae),_defineProperty(_assertThisInitialized(e),"afterDestroy",ae),_defineProperty(_assertThisInitialized(e),"afterDestroyAll",ae),_defineProperty(_assertThisInitialized(e),"afterFind",ae),_defineProperty(_assertThisInitialized(e),"afterFindAll",ae),_defineProperty(_assertThisInitialized(e),"afterSum",ae),_defineProperty(_assertThisInitialized(e),"afterUpdate",ae),_defineProperty(_assertThisInitialized(e),"afterUpdateAll",ae),_defineProperty(_assertThisInitialized(e),"afterUpdateMany",ae),_defineProperty(_assertThisInitialized(e),"beforeCreate",oe),_defineProperty(_assertThisInitialized(e),"beforeCreateMany",oe),_defineProperty(_assertThisInitialized(e),"beforeCount",oe),_defineProperty(_assertThisInitialized(e),"beforeDestroy",oe),_defineProperty(_assertThisInitialized(e),"beforeDestroyAll",oe),_defineProperty(_assertThisInitialized(e),"beforeFind",oe),_defineProperty(_assertThisInitialized(e),"beforeFindAll",oe),_defineProperty(_assertThisInitialized(e),"beforeSum",oe),_defineProperty(_assertThisInitialized(e),"beforeUpdate",oe),_defineProperty(_assertThisInitialized(e),"beforeUpdateAll",oe),_defineProperty(_assertThisInitialized(e),"beforeUpdateMany",oe),Object.defineProperties(_assertThisInitialized(e),{_adapters:{value:void 0,writable:!0},datastore:{value:void 0,writable:!0},lifecycleMethods:{value:se},recordClass:{value:void 0,writable:!0},schema:{value:void 0,writable:!0}}),A.fillIn(_assertThisInitialized(e),t),A.fillIn(_assertThisInitialized(e),A.copy(le)),!e.name)throw A.err("new ".concat(ne),"opts.name")(400,"string",e.name);return e.schema&&(e.schema.type||(e.schema.type="object"),e.schema instanceof te||(e.schema=new te(e.schema||{type:"object"}))),void 0===e.recordClass&&(e.recordClass=function(){function TiedRecord(){return _classCallCheck(this,TiedRecord),_possibleConstructorReturn(this,_getPrototypeOf(TiedRecord).apply(this,arguments))}return _inherits(TiedRecord,M),TiedRecord}()),e.recordClass&&(e.recordClass.mapper=_assertThisInitialized(e),A.isObject(e.methods)&&A.addHiddenPropsToTarget(e.recordClass.prototype,e.methods),Object.isPrototypeOf.call(M,e.recordClass)&&e.schema&&e.schema.apply&&e.applySchema&&e.schema.apply(e.recordClass.prototype)),e}return _inherits(Mapper,i),_createClass(Mapper,[{key:"_end",value:function _end(e,t,n){if(t.raw&&A._(e,t),n)return e;var i=t.raw?e.data:e;return i&&A.isFunction(this.wrap)&&(i=this.wrap(i,t),t.raw?e.data=i:e=i),e}},{key:"belongsTo",value:function belongsTo$1(e,t){return P(e,t)(this)}},{key:"count",value:function count(e,t){return this.crud("count",e,t)}},{key:"create",value:function create(e,t){var n=this,i=0<arguments.length&&void 0!==e?e:{},r=1<arguments.length&&void 0!==t?t:{},o=i,a={},s={};return A._(r,this),r.adapter=this.getAdapterName(r),r.op="beforeCreate",this._runHook(r.op,i,r).then(function(e){return r.with||(r.with=[]),n._createParentRecordIfRequired(e,r)}).then(function(e){a=e}).then(function(){return r.op="create",n._invokeAdapterMethod(r.op,i,r)}).then(function(e){s=e}).then(function(){var e=r.raw?s.data:s;return n._createOrAssignChildRecordIfRequired(e,{opts:r,parentRelationMap:a,originalProps:i})}).then(function(e){return n._commitChanges(o,e)}).then(function(e){r.raw?s.data=e:s=e;var t=n._end(s,r);return r.op="afterCreate",n._runHook(r.op,i,r,t)})}},{key:"_commitChanges",value:function _commitChanges(e,n){var i=this;return A.isArray(e)?e.map(function(e,t){return i._commitChanges(e,n[t])}):(A.set(e,n,{silent:!0}),A.isFunction(e.commit)&&e.commit(),e)}},{key:"createInstance",value:function createInstance(e,t){return this.createRecord(e,t)}},{key:"_createParentRecordIfRequired",value:function _createParentRecordIfRequired(n,e){var i=[],r=[];return A.forEachRelation(this,e,function(e,t){e.isRequiresParentId()&&e.getLocalField(n)&&(t.raw=!1,r.push(e),i.push(e.createParentRecord(n,t)))}),A.Promise.all(i).then(function(i){return r.reduce(function(e,t,n){return t.setLocalField(e,i[n]),e},{})})}},{key:"_createOrAssignChildRecordIfRequired",value:function _createOrAssignChildRecordIfRequired(r,o){var a=[];return A.forEachRelation(this,o.opts,function(e,t){var n=e.getLocalField(o.originalProps);if(n)if(t.raw=!1,e.isRequiresChildId())a.push(e.createChildRecord(r,n,t));else if(e.isRequiresParentId()){var i=e.getLocalField(o.parentRelationMap);i&&e.setLocalField(r,i)}}),A.Promise.all(a).then(function(){return r})}},{key:"createMany",value:function createMany(e,t){var n,u=this,i=0<arguments.length&&void 0!==e?e:[],r=1<arguments.length&&void 0!==t?t:{},c=i;return A._(r,this),r.adapter=this.getAdapterName(r),r.op="beforeCreateMany",this._runHook(r.op,i,r).then(function(a){var s={};r.with||(r.with=[]);var l=[];return A.forEachRelation(u,r,function(i,e){var t=a.map(function(e){return i.getLocalField(e)}).filter(Boolean);i.type===O&&t.length===a.length&&(e.raw=!1,l.push(i.createLinked(t,e).then(function(n){a.forEach(function(e,t){return i.setForeignKey(e,n[t])})}).then(function(e){i.setLocalField(s,e)})))}),A.Promise.all(l).then(function(){return r.op="createMany",u._invokeAdapterMethod(r.op,a,r)}).then(function(e){n=e}).then(function(){var o=r.raw?n.data:n;return l=[],A.forEachRelation(u,r,function(i,e){var n=a.map(function(e){return i.getLocalField(e)}).filter(Boolean);if(n.length===a.length){e.raw=!1;var t,r=i.getLocalField(s);i.type===C?u.log("warn","deep createMany of hasMany type not supported!"):i.type===I?(o.forEach(function(e,t){i.setForeignKey(e,n[t])}),t=i.getRelation().createMany(n,e).then(function(n){o.forEach(function(e,t){i.setLocalField(e,n[t])})})):i.type===O&&r&&r.length===o.length&&o.forEach(function(e,t){i.setLocalField(e,r[t])}),t&&l.push(t)}}),A.Promise.all(l).then(function(){return u._commitChanges(c,o)})})}).then(function(e){r.raw?n.data=e:n=e;var t=u._end(n,r);return r.op="afterCreateMany",u._runHook(r.op,e,r,t)})}},{key:"createRecord",value:function createRecord(t,n){var i=this;if(t=t||{},A.isArray(t))return t.map(function(e){return i.createRecord(e,n)});if(!A.isObject(t))throw A.err("".concat(ne,"#createRecord"),"props")(400,"array or object",t);this.relationList&&this.relationList.forEach(function(e){e.ensureLinkedDataHasProperType(t,n)});var e=this.recordClass;return!e||t instanceof e?t:new e(t,n)}},{key:"crud",value:function crud(n){for(var i=this,e=arguments.length,r=new Array(1<e?e-1:0),t=1;t<e;t++)r[t-1]=arguments[t];var o=this.lifecycleMethods[n];if(!o)throw A.err("".concat(ne,"#crud"),n)(404,"method");var a,s="".concat(n.charAt(0).toUpperCase()).concat(n.substr(1)),l="before".concat(s),u="after".concat(s);o.defaults.forEach(function(e,t){void 0===r[t]&&(r[t]=A.copy(e))});var c=r[r.length-1];A._(c,this);var f=c.adapter=this.getAdapterName(c);return a=c.op=l,A.resolve(this[a].apply(this,_toConsumableArray(r))).then(function(e){var t;return void 0!==r[o.beforeAssign]&&(r[o.beforeAssign]=void 0===e?r[o.beforeAssign]:e),a=c.op=n,r=o.adapterArgs?o.adapterArgs.apply(o,[i].concat(_toConsumableArray(r))):r,i.dbg.apply(i,[a].concat(_toConsumableArray(r))),A.resolve((t=i.getAdapter(f))[a].apply(t,[i].concat(_toConsumableArray(r))))}).then(function(t){var e=/find/.test(a)||c.noValidate,n=Object.assign({},c,{noValidate:e});return t=i._end(t,n,!!o.skip),r.push(t),a=c.op=u,A.resolve(i[a].apply(i,_toConsumableArray(r))).then(function(e){return void 0===e?t:e})})}},{key:"destroy",value:function destroy(e,t){return this.crud("destroy",e,t)}},{key:"destroyAll",value:function destroyAll(e,t){return this.crud("destroyAll",e,t)}},{key:"find",value:function find(e,t){return this.crud("find",e,t)}},{key:"findAll",value:function findAll(e,t){return this.crud("findAll",e,t)}},{key:"getAdapter",value:function getAdapter(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw A.err("".concat(ne,"#getAdapter"),"name")(400,"string",e);return this.getAdapters()[t]}},{key:"getAdapterName",value:function getAdapterName(e){var t=0<arguments.length&&void 0!==e?e:{};return A.isString(t)&&(t={adapter:t}),t.adapter||t.defaultAdapter}},{key:"getAdapters",value:function getAdapters(){return this._adapters}},{key:"getSchema",value:function getSchema(){return this.schema}},{key:"hasMany",value:function hasMany$1(e,t){return Q(e,t)(this)}},{key:"hasOne",value:function hasOne$1(e,t){return R(e,t)(this)}},{key:"is",value:function is(e){var t=this.recordClass;return!!t&&e instanceof t}},{key:"registerAdapter",value:function registerAdapter(e,t,n){var i=2<arguments.length&&void 0!==n?n:{};this.getAdapters()[e]=t,!0!==i&&!i.default||(this.defaultAdapter=e)}},{key:"_runHook",value:function _runHook(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=0===e.indexOf("after")?n.length-1:0;return A.resolve(this[e].apply(this,n)).then(function(e){return void 0===e?n[r]:e})}},{key:"_invokeAdapterMethod",value:function _invokeAdapterMethod(e,t,n){var i,r=this,o={with:n.pass||[]};return this.dbg(n.op,t,n),i=A.isArray(t)?t.map(function(e){return r.toJSON(e,o)}):this.toJSON(t,o),this.getAdapter(n.adapter)[e](this,i,n)}},{key:"sum",value:function sum(e,t,n){return this.crud("sum",e,t,n)}},{key:"toJSON",value:function toJSON(e,t){var i,n=this,r=1<arguments.length&&void 0!==t?t:{};if(A.isArray(e))return e.map(function(e){return n.toJSON(e,r)});i=e;var o=(this?this.relationFields:[])||[],a={};if(this&&this.schema)a=this.schema.pick(i);else for(var s in i)-1===o.indexOf(s)&&(a[s]=A.plainCopy(i[s]));return this&&r.withAll&&(r.with=o.slice()),this&&r.with&&(A.isString(r.with)&&(r.with=[r.with]),A.forEachRelation(this,r,function(t,n){var e=t.getLocalField(i);e&&(A.isArray(e)?t.setLocalField(a,e.map(function(e){return t.getRelation().toJSON(e,n)})):t.setLocalField(a,t.getRelation().toJSON(e,n)))})),a}},{key:"update",value:function update(e,t,n){return this.crud("update",e,t,n)}},{key:"updateAll",value:function updateAll(e,t,n){return this.crud("updateAll",e,t,n)}},{key:"updateMany",value:function updateMany(e,t){return this.crud("updateMany",e,t)}},{key:"validate",value:function validate(e,t){var n=1<arguments.length&&void 0!==t?t:{},i=this.getSchema();if(i){var r=A.pick(n,["existingOnly"]);if(A.isArray(e)){var o=e.map(function(e){return i.validate(e,A.pick(r,["existingOnly"]))});return o.some(Boolean)?o:void 0}return i.validate(e,r)}}},{key:"wrap",value:function wrap(e,t){return this.createRecord(e,t)}},{key:"defineRelations",value:function defineRelations(){var r=this;A.forOwn(this.relations,function(e,i){A.forOwn(e,function(e,n){A.isObject(e)&&(e=[e]),e.forEach(function(e){var t=r.datastore.getMapperByName(n)||n;if(e.getRelation=function(){return r.datastore.getMapper(n)},"function"!=typeof g[i])throw A.err(ne,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",i,!0);r[i](t,e)})})})}}]),Mapper}(),ce="Container",fe=["count","create","createMany","createRecord","destroy","destroyAll","find","findAll","getSchema","is","sum","toJSON","update","updateAll","updateMany","validate"],de=function(){function Container(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,Container),e=_possibleConstructorReturn(this,_getPrototypeOf(Container).call(this)),Object.defineProperties(_assertThisInitialized(e),{_adapters:{value:{}},_mappers:{value:{}},mapperClass:{value:void 0,writable:!0}}),A.fillIn(_assertThisInitialized(e),t),e.mapperDefaults=e.mapperDefaults||{},e.mapperClass||(e.mapperClass=ue),e}return _inherits(Container,i),_createClass(Container,[{key:"_onMapperEvent",value:function _onMapperEvent(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n.shift();this.emit.apply(this,[r,e].concat(n))}},{key:"as",value:function as(r){var e={},o=this;return fe.forEach(function(i){e[i]={writable:!0,value:function value(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[i].apply(o,[r].concat(t))}}}),e.getMapper={writable:!0,value:function value(){return o.getMapper(r)}},Object.create(this,e)}},{key:"defineMapper",value:function defineMapper(i,e){var r=this,t=1<arguments.length&&void 0!==e?e:{};if(A.isObject(i)&&(i=(t=i).name),!A.isString(i))throw A.err("".concat(ce,"#defineMapper"),"name")(400,"string",i);t.name=i,t.relations||(t.relations={});var n=t.mapperClass||this.mapperClass;delete t.mapperClass,A.fillIn(t,this.mapperDefaults);var o=this._mappers[i]=new n(t);return o.relations||(o.relations={}),o.name=i,o._adapters=this.getAdapters(),o.datastore=this,o.on("all",function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return r._onMapperEvent.apply(r,[i].concat(t))}),o.defineRelations(),o}},{key:"defineResource",value:function defineResource(e,t){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(e,t)}},{key:"getAdapter",value:function getAdapter(e){var t=this.getAdapterName(e);if(!t)throw A.err("".concat(ce,"#getAdapter"),"name")(400,"string",e);return this.getAdapters()[t]}},{key:"getAdapterName",value:function getAdapterName(e){var t=0<arguments.length&&void 0!==e?e:{};return A.isString(t)&&(t={adapter:t}),t.adapter||this.mapperDefaults.defaultAdapter}},{key:"getAdapters",value:function getAdapters(){return this._adapters}},{key:"getMapper",value:function getMapper(e){var t=this.getMapperByName(e);if(!t)throw A.err("".concat(ce,"#getMapper"),e)(404,"mapper");return t}},{key:"getMapperByName",value:function getMapperByName(e){return this._mappers[e]}},{key:"registerAdapter",value:function registerAdapter(t,e,n){var i=2<arguments.length&&void 0!==n?n:{};this.getAdapters()[t]=e,!0!==i&&!i.default||(this.mapperDefaults.defaultAdapter=t,A.forOwn(this._mappers,function(e){e.defaultAdapter=t}))}},{key:"count",value:function count(e,t){return this.getMapper(e).count(t)}},{key:"create",value:function create(e,t,n){return this.getMapper(e).create(t,n)}},{key:"createMany",value:function createMany(e,t,n){return this.getMapper(e).createMany(t,n)}},{key:"createRecord",value:function createRecord(e,t,n){return this.getMapper(e).createRecord(t,n)}},{key:"destroy",value:function destroy(e,t,n){return this.getMapper(e).destroy(t,n)}},{key:"destroyAll",value:function destroyAll(e,t,n){return this.getMapper(e).destroyAll(t,n)}},{key:"find",value:function find(e,t,n){return this.getMapper(e).find(t,n)}},{key:"findAll",value:function findAll(e,t,n){return this.getMapper(e).findAll(t,n)}},{key:"getSchema",value:function getSchema(e){return this.getMapper(e).getSchema()}},{key:"is",value:function is(e,t){return this.getMapper(e).is(t)}},{key:"sum",value:function sum(e,t,n,i){return this.getMapper(e).sum(t,n,i)}},{key:"toJSON",value:function toJSON(e,t,n){return this.getMapper(e).toJSON(t,n)}},{key:"update",value:function update(e,t,n,i){return this.getMapper(e).update(t,n,i)}},{key:"updateAll",value:function updateAll(e,t,n,i){return this.getMapper(e).updateAll(t,n,i)}},{key:"updateMany",value:function updateMany(e,t,n){return this.getMapper(e).updateMany(t,n)}},{key:"validate",value:function validate(e,t,n){return this.getMapper(e).validate(t,n)}}]),Container}(),he=["add","between","createIndex","filter","get","getAll","prune","query","toJSON","unsaved"],pe=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],ve={usePendingFind:!0,usePendingFindAll:!0},ye=function(){function SimpleStore(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,SimpleStore),A.fillIn(t,ve),_defineProperty(_assertThisInitialized(e=_possibleConstructorReturn(this,_getPrototypeOf(SimpleStore).call(this,t))),"cachedFind",Ua),_defineProperty(_assertThisInitialized(e),"cachedFindAll",Ua),e.collectionClass=e.collectionClass||q,e._collections={},e._pendingQueries={},e._completedQueries={},e}return _inherits(SimpleStore,de),_createClass(SimpleStore,[{key:"_end",value:function _end(e,t,n){var i=n.raw?t.data:t;return i&&A.isFunction(this.addToCache)&&(i=this.addToCache(e,i,n),n.raw?t.data=i:t=i),t}},{key:"_onCollectionEvent",value:function _onCollectionEvent(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n.shift();this.emit.apply(this,[r,e].concat(n))}},{key:"addToCache",value:function addToCache(e,t,n){return this.getCollection(e).add(t,n)}},{key:"as",value:function as(r){var e={},o=this;return pe.concat(fe).concat(he).forEach(function(i){e[i]={writable:!0,value:function value(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[i].apply(o,[r].concat(t))}}}),e.getMapper={writable:!0,value:function value(){return o.getMapper(r)}},e.getCollection={writable:!0,value:function value(){return o.getCollection(r)}},Object.create(this,e)}},{key:"cacheFind",value:function cacheFind(e,t,n){var i=this;this._completedQueries[e][n]=function(e,t,n){return i.get(e,t)}}},{key:"cacheFindAll",value:function cacheFindAll(e,t,n){var i=this;this._completedQueries[e][n]=function(e,t,n){return i.filter(e,A.fromJson(t))}}},{key:"clear",value:function clear(){var n=this,i={};return A.forOwn(this._collections,function(e,t){i[t]=e.removeAll(),n._completedQueries[t]={}}),i}},{key:"create",value:function create(t,e,n){var i=this,r=2<arguments.length&&void 0!==n?n:{};return _get(_getPrototypeOf(SimpleStore.prototype),"create",this).call(this,t,e,r).then(function(e){return i._end(t,e,r)})}},{key:"createMany",value:function createMany(t,e,n){var i=this,r=2<arguments.length&&void 0!==n?n:{};return _get(_getPrototypeOf(SimpleStore.prototype),"createMany",this).call(this,t,e,r).then(function(e){return i._end(t,e,r)})}},{key:"defineMapper",value:function defineMapper(i,e){var r=this,t=_get(_getPrototypeOf(SimpleStore.prototype),"defineMapper",this).call(this,i,e);r._pendingQueries[i]={},r._completedQueries[i]={},t.relationList||Object.defineProperty(t,"relationList",{value:[]});var n={_added:{},datastore:r,mapper:t};e&&"onConflict"in e&&(n.onConflict=e.onConflict);var o=r._collections[i]=new r.collectionClass(null,n),a=(t.schema||{}).properties||{};return A.forOwn(a,function(e,t){e.indexed&&o.createIndex(t)}),o.createIndex("addedTimestamps",["$"],{fieldGetter:function fieldGetter(e){return o._added[o.recordId(e)]}}),o.on("all",function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];r._onCollectionEvent.apply(r,[i].concat(t))}),t}},{key:"destroy",value:function destroy(n,i,e){var r=this,o=2<arguments.length&&void 0!==e?e:{};return _get(_getPrototypeOf(SimpleStore.prototype),"destroy",this).call(this,n,i,o).then(function(e){var t=r.getCollection(n).remove(i,o);return o.raw?e.data=t:e=t,delete r._pendingQueries[n][i],delete r._completedQueries[n][i],e})}},{key:"destroyAll",value:function destroyAll(i,r,e){var o=this,a=2<arguments.length&&void 0!==e?e:{};return _get(_getPrototypeOf(SimpleStore.prototype),"destroyAll",this).call(this,i,r,a).then(function(e){var t=o.getCollection(i).removeAll(r,a);a.raw?e.data=t:e=t;var n=o.hashQuery(i,r,a);return delete o._pendingQueries[i][n],delete o._completedQueries[i][n],e})}},{key:"eject",value:function eject(e,t,n){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(e,t,n)}},{key:"ejectAll",value:function ejectAll(e,t,n){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(e,t,n)}},{key:"find",value:function find(t,n,e){var i=this,r=2<arguments.length&&void 0!==e?e:{},o=this.getMapper(t),a=this._pendingQueries[t][n],s=void 0===r.usePendingFind?this.usePendingFind:r.usePendingFind;if(A._(r,o),a&&(A.isFunction(s)?s.call(this,t,n,r):s))return a;var l=this.cachedFind(t,n,r);return!r.force&&l?A.resolve(l):(this._pendingQueries[t][n]=_get(_getPrototypeOf(SimpleStore.prototype),"find",this).call(this,t,n,r)).then(function(e){return delete i._pendingQueries[t][n],e=i._end(t,e,r),i.cacheFind(t,e,n,r),e},function(e){return delete i._pendingQueries[t][n],A.reject(e)})}},{key:"findAll",value:function findAll(t,e,n){var i=this,r=2<arguments.length&&void 0!==n?n:{},o=this.getMapper(t),a=this.hashQuery(t,e,r),s=this._pendingQueries[t][a],l=void 0===r.usePendingFindAll?this.usePendingFindAll:r.usePendingFindAll;if(A._(r,o),s&&(A.isFunction(l)?l.call(this,t,e,r):l))return s;var u=this.cachedFindAll(t,a,r);return!r.force&&u?A.resolve(u):(this._pendingQueries[t][a]=_get(_getPrototypeOf(SimpleStore.prototype),"findAll",this).call(this,t,e,r)).then(function(e){return delete i._pendingQueries[t][a],e=i._end(t,e,r),i.cacheFindAll(t,e,a,r),e},function(e){return delete i._pendingQueries[t][a],A.reject(e)})}},{key:"getCollection",value:function getCollection(e){var t=this._collections[e];if(!t)throw A.err("".concat("SimpleStore","#getCollection"),e)(404,"collection");return t}},{key:"hashQuery",value:function hashQuery(e,t){return A.toJson(t||{})}},{key:"inject",value:function inject(e,t,n){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(e,t,n)}},{key:"remove",value:function remove(e,t,n){var i=this.getCollection(e).remove(t,n);return i&&this.removeRelated(e,[i],n),i}},{key:"removeAll",value:function removeAll(e,t,n){t&&Object.keys(t).length?this._completedQueries[e][this.hashQuery(e,t,n)]=void 0:this._completedQueries[e]={};var i=this.getCollection(e).removeAll(t,n);return i.length&&this.removeRelated(e,i,n),i}},{key:"removeRelated",value:function removeRelated(e,t,n){var o=this;A.isArray(t)||(t=[t]),A.forEachRelation(this.getMapper(e),n,function(i,r){t.forEach(function(e){var t,n;if(!i.foreignKey||i.type!==I&&i.type!==C?i.type===C&&i.localKeys?n={where:_defineProperty({},i.getRelation().idAttribute,{in:A.get(e,i.localKeys)})}:i.type===C&&i.foreignKeys?n={where:_defineProperty({},i.foreignKeys,{contains:i.getForeignKey(e)})}:i.type===O&&(t=o.remove(i.relation,i.getForeignKey(e),r)):n=_defineProperty({},i.foreignKey,i.getForeignKey(e)),n&&(t=o.removeAll(i.relation,n,r)),t){if(A.isArray(t)&&!t.length)return;i.type===I&&(t=t[0]),i.setLocalField(e,t)}})})}},{key:"update",value:function update(t,e,n,i){var r=this,o=3<arguments.length&&void 0!==i?i:{};return _get(_getPrototypeOf(SimpleStore.prototype),"update",this).call(this,t,e,n,o).then(function(e){return r._end(t,e,o)})}},{key:"updateAll",value:function updateAll(t,e,n,i){var r=this,o=3<arguments.length&&void 0!==i?i:{};return _get(_getPrototypeOf(SimpleStore.prototype),"updateAll",this).call(this,t,e,n,o).then(function(e){return r._end(t,e,o)})}},{key:"updateMany",value:function updateMany(t,e,n){var i=this,r=2<arguments.length&&void 0!==n?n:{};return _get(_getPrototypeOf(SimpleStore.prototype),"updateMany",this).call(this,t,e,r).then(function(e){return i._end(t,e,r)})}},{key:"add",value:function add(e,t,n){return this.getCollection(e).add(t,n)}},{key:"between",value:function between(e,t,n,i){return this.getCollection(e).between(t,n,i)}},{key:"createIndex",value:function createIndex(e,t,n,i){return this.getCollection(e).createIndex(t,n,i)}},{key:"filter",value:function filter(e,t,n){return this.getCollection(e).filter(t,n)}},{key:"get",value:function get(e,t){return this.getCollection(e).get(t)}},{key:"getAll",value:function getAll(e){for(var t,n=arguments.length,i=new Array(1<n?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return(t=this.getCollection(e)).getAll.apply(t,i)}},{key:"prune",value:function prune(e,t){return this.getCollection(e).prune(t)}},{key:"query",value:function query(e){return this.getCollection(e).query()}},{key:"toJSON",value:function toJSON(e,t){return this.getCollection(e).toJSON(t)}},{key:"unsaved",value:function unsaved(e,t){return this.getCollection(e).unsaved(t)}}]),SimpleStore}(),ge=function(){function LinkedCollection(e,t){var n;if(_classCallCheck(this,LinkedCollection),!(n=_possibleConstructorReturn(this,_getPrototypeOf(LinkedCollection).call(this,e,t))).datastore)throw A.err("new ".concat("LinkedCollection"),"opts.datastore")(400,"DataStore",n.datastore);return n}return _inherits(LinkedCollection,q),_createClass(LinkedCollection,[{key:"_addMeta",value:function _addMeta(e,t){this._added[this.recordId(e)]=t,A.isFunction(e._set)&&e._set("$",t)}},{key:"_clearMeta",value:function _clearMeta(e){delete this._added[this.recordId(e)],A.isFunction(e._set)&&e._set("$")}},{key:"_onRecordEvent",value:function _onRecordEvent(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];q.prototype._onRecordEvent.apply(this,t);var i=t[0];A.isString(i)&&0===i.indexOf("change")&&this.updateIndexes(t[1])}},{key:"add",value:function add(t,e){var n=this,i=this.mapper,r=(new Date).getTime(),o=A.isObject(t)&&!A.isArray(t);return o&&(t=[t]),t=_get(_getPrototypeOf(LinkedCollection.prototype),"add",this).call(this,t,e),i.relationList.length&&t.length&&i.relationList.forEach(function(e){e.addLinkedRecords(t)}),t.forEach(function(e){return n._addMeta(e,r)}),o?t[0]:t}},{key:"remove",value:function remove(e,t){var n=this.mapper,i=_get(_getPrototypeOf(LinkedCollection.prototype),"remove",this).call(this,e,t);return i&&this._clearMeta(i),n.relationList.length&&i&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,[i])}),i}},{key:"removeAll",value:function removeAll(e,t){var n=this.mapper,i=_get(_getPrototypeOf(LinkedCollection.prototype),"removeAll",this).call(this,e,t);return i.forEach(this._clearMeta,this),n.relationList.length&&i.length&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,i)}),i}}]),LinkedCollection}(),me={unlinkOnDestroy:!0},_e=function(){function DataStore(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,DataStore),A.fillIn(e,me),e.collectionClass||(e.collectionClass=ge),_possibleConstructorReturn(this,_getPrototypeOf(DataStore).call(this,e))}return _inherits(DataStore,ye),_createClass(DataStore,[{key:"defineMapper",value:function defineMapper(e,t){var _=this,k=_get(_getPrototypeOf(DataStore.prototype),"defineMapper",this).call(this,e,t),b=k.idAttribute,u=this.getCollection(e);return k.relationList.forEach(function(c){function cC(){return this._get(h)}var e,f=c.relation,d=c.localField,h="links.".concat(d),p=c.foreignKey,t=c.type,y={index:p};if(t===O){u.indexes[p]||u.createIndex(p),e={get:cC,set:function set(e){var t=this._get(h);if(e===t)return t;var n=A.get(this,b),i=c.getInverse(k);if(t&&i&&this.removeInverseRelation(t,n,i,b),e){var r=c.getRelation().idAttribute,o=A.get(e,r);void 0!==o&&this._get("$")&&(e=_.get(f,o)||e),w(this,d,e),v(this,p,o),u.updateIndex(this,y),i&&this.setupInverseRelation(e,n,i,b)}else w(this,d,void 0);return e}};var n=Object.getOwnPropertyDescriptor(k.recordClass.prototype,p),i=(n=n||{enumerable:!0}).get;n.get=function(){return i?i.call(this):this._get("props.".concat(p))};var l=n.set;n.set=function(e){var t=this;l&&l.call(this,e);var n=A.get(this,d),i=A.get(this,b),r=c.getInverse(k),o=n?A.get(n,c.getRelation().idAttribute):void 0;if(r&&n&&void 0!==o&&o!==e)if(r.type===I)w(n,r.localField,void 0);else if(r.type===C){var a=A.get(n,r.localField);void 0===i?A.remove(a,function(e){return e===t}):A.remove(a,function(e){return e===t||i===A.get(e,b)})}if(v(this,p,e),u.updateIndex(this,y),null==e)void 0!==o&&A.set(this,d,void 0);else if(this._get("$")){var s=_.get(f,e);s&&A.set(this,d,s)}},Object.defineProperty(k.recordClass.prototype,p,n)}else if(t===C){var g=c.localKeys,m=c.foreignKeys;_._collections[f]&&p&&!_.getCollection(f).indexes[p]&&_.getCollection(f).createIndex(p),e={get:function get(){return cC.call(this)||this._set(h,[]),cC.call(this)},set:function set(n){var r=this;n&&!A.isArray(n)&&(n=[n]);var i=A.get(this,b),o=c.getRelation().idAttribute,e=c.getInverse(k),a=e.localField,t=this._get(h)||[],s=[],l={};if(n&&n.forEach(function(t){var n=A.get(t,o),e=A.get(t,a);if(e&&e!==r){var i=A.get(e,d);void 0===n?A.remove(i,function(e){return e===t}):A.remove(i,function(e){return e===t||n===A.get(e,o)})}void 0!==n&&(r._get("$")&&(t=_.get(f,n)||t),l[n]=t),s.push(t)}),p)t.forEach(function(e){var t=A.get(e,o);(void 0!==t||-1!==s.indexOf(e))&&(void 0===t||t in l)||(n&&(v(e,p,void 0),_.getCollection(f).updateIndex(e,y)),w(e,a,void 0))}),s.forEach(function(e){v(e,p,i),_.getCollection(f).updateIndex(e,y),w(e,a,r)});else if(g){var u=s.map(function(e){return A.get(e,o)}).filter(function(e){return void 0!==e});A.set(this,g,u),e.foreignKeys&&(t.forEach(function(e){var t=A.get(e,o);if(void 0===t&&-1===s.indexOf(e)||void 0!==t&&!(t in l)){var n=A.get(e,a)||[];void 0===i?A.remove(n,function(e){return e===r}):A.remove(n,function(e){return e===r||i===A.get(e,b)})}}),s.forEach(function(e){var t=A.get(e,a);void 0===i?A.noDupeAdd(t,r,function(e){return e===r}):A.noDupeAdd(t,r,function(e){return e===r||i===A.get(e,b)})}))}else m&&(t.forEach(function(e){var t=A.get(e,m)||[];A.remove(t,function(e){return i===e});var n=A.get(e,a);void 0===i?A.remove(n,function(e){return e===r}):A.remove(n,function(e){return e===r||i===A.get(e,b)})}),s.forEach(function(e){var t=A.get(e,m)||[];A.noDupeAdd(t,i,function(e){return i===e});var n=A.get(e,a);void 0===i?A.noDupeAdd(n,r,function(e){return e===r}):A.noDupeAdd(n,r,function(e){return e===r||i===A.get(e,b)})}));return this._set(h,s),s}}}else t===I&&(_._collections[f]&&p&&!_.getCollection(f).indexes[p]&&_.getCollection(f).createIndex(p),e={get:cC,set:function set(e){var t=this._get(h);if(e===t)return t;var n=c.getInverse(k).localField;if(t&&(v(t,p,void 0),_.getCollection(f).updateIndex(t,y),w(t,n,void 0)),e){var i=A.get(e,c.getRelation().idAttribute);void 0!==i&&(e=_.get(f,i)||e),w(this,d,e),v(e,p,A.get(this,b)),_.getCollection(f).updateIndex(e,y),w(e,n,this)}else w(this,d,void 0);return e}});if(e){if(e.enumerable=void 0!==c.enumerable&&c.enumerable,c.get){var r=e.get;e.get=function(){var i=this;return c.get(c,this,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return r.apply(i,t)})}}if(c.set){var o=e.set;e.set=function(t){var n=this;return c.set(c,this,t,function(e){return o.call(n,void 0===e?t:e)})}}Object.defineProperty(k.recordClass.prototype,d,e)}}),k}},{key:"destroy",value:function destroy(i,e,t){var r=this,o=2<arguments.length&&void 0!==t?t:{};return _get(_getPrototypeOf(DataStore.prototype),"destroy",this).call(this,i,e,o).then(function(e){var t;if((t=o.raw?e.data:e)&&r.unlinkOnDestroy){var n=A.plainCopy(o);n.withAll=!0,A.forEachRelation(r.getMapper(i),n,function(e){A.set(t,e.localField,void 0)})}return e})}},{key:"destroyAll",value:function destroyAll(i,e,t){var r=this,o=2<arguments.length&&void 0!==t?t:{};return _get(_getPrototypeOf(DataStore.prototype),"destroyAll",this).call(this,i,e,o).then(function(e){var n;if((n=o.raw?e.data:e)&&n.length&&r.unlinkOnDestroy){var t=A.plainCopy(o);t.withAll=!0,A.forEachRelation(r.getMapper(i),t,function(t){n.forEach(function(e){A.set(e,t.localField,void 0)})})}return e})}}]),DataStore}();e.Collection=q,e.Component=i,e.Container=de,e.DataStore=_e,e.Index=L,e.LinkedCollection=ge,e.Mapper=ue,e.Query=y,e.Record=M,e.Schema=te,e.Settable=x,e.SimpleStore=ye,e.belongsTo=P,e.belongsToType=O,e.hasMany=Q,e.hasManyType=C,e.hasOne=R,e.hasOneType=I,e.utils=A,e.version={full:"3.0.6",major:3,minor:0,patch:6},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=js-data.min.map