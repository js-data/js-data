/*!
* js-data
* @version 3.0.6 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t((e=e||self).JSData={})}(this,function(e){"use strict";var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function __extends(e,t){function __(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}var r=function(){return(r=Object.assign||function __assign(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function __spreadArrays(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r}var i="[object Number]",a="[object RegExp]",t=Object.prototype.toString,s=/^(.+)\.(.+)$/,u={400:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return"expected: "+e[0]+", found: "+(e[2]?e[1]:typeof e[1])},404:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e[0]+" not found"}},l=function(e){return t.call(e)},o=function(e){return!!e&&"object"==typeof e&&e.constructor===Object},b={_:function(n,e){b.forOwn(e,function(e,t){t&&void 0===n[t]&&!b.isFunction(e)&&0!==t.indexOf("_")&&(n[t]=e)})},_forRelation:function(e,t,n,r){void 0===e&&(e={});var i,o=t.relation,a=null;if(e.with=e.with||[],0<=(i=b._getIndex(e.with,o))?a=o:0<=(i=b._getIndex(e.with,t.localField))&&(a=t.localField),e.withAll)n.call(r,t,{});else if(a){var s={};b.fillIn(s,t.getRelation()),b.fillIn(s,e),s.with=e.with.slice(),s._activeWith=s.with.splice(i,1)[0],s.with.forEach(function(e,t){e&&0===e.indexOf(a)&&e.length>=a.length&&"."===e[a.length]?s.with[t]=e.substr(a.length+1):s.with[t]=""}),n.call(r,t,s)}},_getIndex:function(e,n){var r=-1;return e.forEach(function(e,t){return e===n?(r=t,!1):b.isObject(e)&&e.relation===n?(r=t,!1):void 0}),r},addHiddenPropsToTarget:function(e,n){var r={};Object.keys(n).forEach(function(e){var t=Object.getOwnPropertyDescriptor(n,e);t.enumerable=!1,r[e]=t}),Object.defineProperties(e,r)},areDifferent:function(e,t,n){void 0===n&&(n={});var r=b.diffObjects(e,t,n);return 0<Object.keys(r.added).length+Object.keys(r.removed).length+Object.keys(r.changed).length},copy:function(e,n,t,r,i,o){if(n){if(e===n)throw b.err("utils.copy")(500,"Cannot copy! Source and destination are identical.");if(t=t||[],r=r||[],b.isObject(e)){var a=t.indexOf(e);if(-1!==a)return r[a];t.push(e),r.push(n)}var s=void 0;if(b.isArray(e)){var u=void 0;for(u=n.length=0;u<e.length;u++)s=b.copy(e[u],null,t,r,i,o),b.isObject(e[u])&&(t.push(e[u]),r.push(s)),n.push(s)}else for(var l in b.isArray(n)?n.length=0:b.forOwn(n,function(e,t){delete n[t]}),e)if(e.hasOwnProperty(l)){if(b.isBlacklisted(l,i))continue;s=b.copy(e[l],null,t,r,i,o),b.isObject(e[l])&&(t.push(e[l]),r.push(s)),n[l]=s}}else(n=e)&&(b.isArray(e)?n=b.copy(e,[],t,r,i,o):b.isDate(e)?n=new Date(e.getTime()):b.isRegExp(e)?(n=new RegExp(e.source,e.toString().match(/[^/]*$/)[0])).lastIndex=e.lastIndex:b.isObject(e)&&(n=o?b.copy(e,{},t,r,i,o):b.copy(e,Object.create(Object.getPrototypeOf(e)),t,r,i,o)));return n},deepFillIn:function(r,e){return e&&b.forOwn(e,function(e,t){var n=r[t];o(e)&&o(n)?b.deepFillIn(n,e):r.hasOwnProperty(t)&&void 0!==r[t]||(r[t]=e)}),r},deepMixIn:function(e,t){if(t)for(var n in t){var r=t[n],i=e[n];o(r)&&o(i)?b.deepMixIn(i,r):e[n]=r}return e},diffObjects:function(r,i,e){void 0===e&&(e={});var o=e.equalsFn,t=e.ignore,a={added:{},changed:{},removed:{}};b.isFunction(o)||(o=b.deepEqual);var n=Object.keys(r).filter(function(e){return!b.isBlacklisted(e,t)}),s=Object.keys(i).filter(function(e){return!b.isBlacklisted(e,t)});return n.forEach(function(e){var t=i[e],n=r[e];o(t,n)||(void 0===t?a.added[e]=n:a.changed[e]=n)}),s.forEach(function(e){var t=i[e];void 0===r[e]&&void 0!==t&&(a.removed[e]=void 0)}),a},equal:function(e,t){return e==t},err:function(o,a){return function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r="["+o+":"+a+"] ",i=u[e].apply(null,t);return i=""+r+i+"\nhttp://www.js-data.io/v3.0/docs/errors#"+e,new Error(i)}},eventify:function(e,a,i){e=e||this;var t={};a||i||(a=function(){return t},i=function(e){return t=e}),Object.defineProperties(e,{emit:{value:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n,r=a.call(this)||{},i=e.shift(),o=r[i]||[];for(n=0;n<o.length;n++)o[n].f.apply(o[n].c,e);for(o=r.all||[],e.unshift(i),n=0;n<o.length;n++)o[n].f.apply(o[n].c,e)}},off:{value:function(e,t){var n=a.call(this)[e];if(n)if(t){for(var r=0;r<n.length;r++)if(n[r].f===t){n.splice(r,1);break}}else n.splice(0,n.length);else i.call(this,{})}},on:{value:function(e,t,n){a.call(this)||i.call(this,{});var r=a.call(this);r[e]=r[e]||[],r[e].push({c:n,f:t})}}})},fillIn:function(n,e){b.forOwn(e,function(e,t){n.hasOwnProperty(t)&&void 0!==n[t]||(n[t]=e)})},findIndex:function(e,n){var r=-1;return e&&e.forEach(function(e,t){if(n(e))return r=t,!1}),r},forEachRelation:function(e,t,n,r){var i=e.relationList||[];i.length&&i.forEach(function(e){b._forRelation(t,e,n,r)})},forOwn:function(e,t,n){var r,i=Object.keys(e),o=i.length;for(r=0;r<o&&!1!==t.call(n,e[i[r]],i[r],e);r++);},fromJson:function(e){return b.isString(e)?JSON.parse(e):e},get:function(e,t){if(t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(null==(e=e[t]))return;return e[r]}},getSuper:function(e,t){var n=t?e:e.constructor;return n.hasOwnProperty("__super__")?n.__super__:Object.getPrototypeOf(n)||n.__proto__},intersection:function(e,t){if(!e||!t)return[];e=Array.isArray(e)?e:[e],t=Array.isArray(t)?t:[t];var n,r,i=[],o=e.length;for(r=0;r<o;r++)n=e[r],-1===i.indexOf(n)&&-1!==t.indexOf(n)&&i.push(n);return i},isArray:Array.isArray,isBlacklisted:function(e,t){if(!t||!t.length)return!1;for(var n,r=0,i=t;r<i.length;r++){var o=i[r];if(l(o)===a&&o.test(e)||o===e)return!!(n=e)}return!!n},isBoolean:function(e){return"[object Boolean]"===l(e)},isDate:function(e){return e&&"object"==typeof e&&"[object Date]"===l(e)},isFunction:function(e){return"function"==typeof e||e&&"[object Function]"===l(e)},isInteger:function(e){return l(e)===i&&e==function(e){if(!e)return 0;if((e=+e)==1/0||e===-1/0)return 17976931348623157e292*(e<0?-1:1);var t=e%1;return e==e?t?e-t:e:0}(e)},isNull:function(e){return null===e},isNumber:function(e){var t=typeof e;return"number"===t||e&&"object"===t&&l(e)===i},isObject:function(e){return"[object Object]"===l(e)},isRegExp:function(e){return l(e)===a},isSorN:function(e){return b.isString(e)||b.isNumber(e)},isString:function(e){return"string"==typeof e||e&&"object"==typeof e&&"[object String]"===l(e)},isUndefined:function(e){return void 0===e},logify:function(e){b.addHiddenPropsToTarget(e,{dbg:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];b.isFunction(this.log)&&this.log.apply(this,__spreadArrays(["debug"],e))},log:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(e&&!t.length&&(t.push(e),e="debug"),"debug"!==e||this.debug){var r=e.toUpperCase()+": ("+(this.name||this.constructor.name)+")";b.isFunction(console[e])?console[e].apply(console,__spreadArrays([r],t)):console.log.apply(console,__spreadArrays([r],t))}}})},noDupeAdd:function(e,t,n){e&&(this.findIndex(e,n)<0&&e.push(t))},omit:function(e,n){var r={};return b.forOwn(e,function(e,t){-1===n.indexOf(t)&&(r[t]=e)}),r},pick:function(n,e){return e.reduce(function(e,t){return e[t]=n[t],e},{})},plainCopy:function(e){return b.copy(e,void 0,void 0,void 0,void 0,!0)},reject:function(e){return Promise.reject(e)},remove:function(e,t){if(e&&e.length){var n=this.findIndex(e,t);0<=n&&e.splice(n,1)}},resolve:function(e){return Promise.resolve(e)},set:function(n,e,t,r){if(b.isObject(e))b.forOwn(e,function(e,t){b.set(n,t,e)});else{var i=s.exec(e);i?(o=n,a=i[1],a&&a.split(".").forEach(function(e){o[e]||(o[e]={}),o=o[e]}),o)[i[2]]=t:n[e]=t}var o,a},deepEqual:function(n,r){if(n===r)return!0;var i=!0;if(b.isArray(n)&&b.isArray(r)){if(n.length!==r.length)return!1;for(var e=n.length;e--;)if(!b.deepEqual(n[e],r[e]))return!1}else{if(!b.isObject(n)||!b.isObject(r))return!1;b.forOwn(n,function(e,t){if(!(i=b.deepEqual(e,r[t])))return!1}),i&&b.forOwn(r,function(e,t){if(!(i=b.deepEqual(e,n[t])))return!1})}return i},toJson:JSON.stringify,unset:function(e,t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(null==(e=e[t]))return;e[r]=void 0}},O=function(e,t,n){var r;(null===(r=e)||void 0===r?void 0:r._set)?e._set("props."+t,n):b.set(e,t,n)},C=function(e,t,n){var r;(null===(r=e)||void 0===r?void 0:r._set)?e._set("links."+t,n):b.set(e,t,n)},c=function Settable(){var n={};Object.defineProperties(this,{_get:{value:function(e){return b.get(n,e)}},_set:{value:function(e,t){return b.set(n,e,t)}},_unset:{value:function(e){return b.unset(n,e)}}})},p=function(r){function Component(e){var t;void 0===e&&(e={});var n=r.call(this)||this;return n._listeners={},n.debug=null!=(t=e.debug)&&t,n}return __extends(Component,r),Component}(c);b.logify(p.prototype),b.eventify(p.prototype,function(){return this._listeners},function(e){this._listeners=e});var f="Query",d="Index inaccessible after first operation",h={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},v=/([.*+?^=!:${}()|[\]/\\])/g,y=/%/g,g=/_/g;var m=function(n){function Query(e){var t=n.call(this)||this;return t.collection=e,t.data=null,t}return __extends(Query,n),Query.prototype._applyWhereFromObject=function(e){var r=[],i=[],o=[];return b.forOwn(e,function(e,n){b.isObject(e)||(e={"==":e}),b.forOwn(e,function(e,t){r.push(n),i.push(t),o.push(e)})}),{fields:r,ops:i,predicates:o}},Query.prototype._applyWhereFromArray=function(i){var o=this,a=[];return i.forEach(function(e,t){if(!b.isString(e)){var n=i[t-1],r=(b.isArray(e)?o._applyWhereFromArray:o._applyWhereFromObject).call(o,e);"or"===n&&(r.isOr=!0),a.push(r)}}),a.isArray=!0,a},Query.prototype._testObjectGroup=function(e,t,n,r){var i,o=n.fields,a=n.ops,s=n.predicates,u=a.length;for(i=0;i<u;i++){var l=a[i],c="|"===l.charAt(0);l=c?l.substr(1):l;var p=this.evaluate(b.get(r,o[i]),l,s[i]);void 0!==p&&(e=t?p:c?e||p:e&&p),t=!1}return{keep:e,first:t}},Query.prototype._testArrayGroup=function(e,t,n,r){var i,o=n.length;for(i=0;i<o;i++){var a=n[i],s=(a.isArray?this._testArrayGroup:this._testObjectGroup).call(this,!0,!0,a,r);e=n[i-1]?a.isOr?e||s.keep:e&&s.keep:s.keep,t=s.first}return{keep:e,first:t}},Query.prototype.between=function(e,t,n){if(void 0===n&&(n={}),this.data)throw b.err(f+"#between")(500,"Cannot access index");return this.data=this.collection.getIndex(n.index).between(e,t,n),this},Query.prototype.compare=function(e,t,n,r){var i=e[t],o=b.get(n,i[0]),a=b.get(r,i[0]);if(o&&b.isString(o)&&(o=o.toUpperCase()),a&&b.isString(a)&&(a=a.toUpperCase()),void 0===n&&(n=null),void 0===r&&(r=null),"DESC"===i[1].toUpperCase()){var s=a;a=o,o=s}return o<a?-1:a<o?1:t<e.length-1?this.compare(e,t+1,n,r):0},Query.prototype.evaluate=function(e,t,n){var r=Query.ops;return r[t]?r[t](e,n):0===t.indexOf("like")?null!==this.like(n,t.substr(4)).exec(e):0===t.indexOf("notLike")?null===this.like(n,t.substr(7)).exec(e):void 0},Query.prototype.filter=function(e,t){var n=this;if(void 0===e&&(e={}),this.getData(),b.isObject(e)){var r,i={};(b.isObject(e.where)||b.isArray(e.where))&&(i=e.where),b.forOwn(e,function(e,t){t in h||t in i||(i[t]={"==":e})}),b.isObject(i)&&0!==Object.keys(i).length?r=this._applyWhereFromArray([i]):b.isArray(i)&&(r=this._applyWhereFromArray(i)),r&&(this.data=this.data.filter(function(e){return n._testArrayGroup(!0,!0,r,e).keep}));var o=e.orderBy||e.sort;if(b.isString(o)&&(o=[[o,"ASC"]]),b.isArray(o)||(o=null),o){o.forEach(function(e,t){b.isString(e)&&(o[t]=[e,"ASC"])}),this.data.sort(function(e,t){return n.compare(o,0,e,t)})}b.isNumber(e.skip)?this.skip(e.skip):b.isNumber(e.offset)&&this.skip(e.offset),b.isNumber(e.limit)&&this.limit(e.limit)}else b.isFunction(e)&&(this.data=this.data.filter(e,t));return this},Query.prototype.forEach=function(e,t){return this.getData().forEach(e,t),this},Query.prototype.get=function(e,t){if(void 0===e&&(e=[]),void 0===t&&(t={}),this.data)throw b.err(f+"#get")(500,d);return e&&!b.isArray(e)&&(e=[e]),e.length?this.data=this.collection.getIndex(t.index).get(e):this.getData(),this},Query.prototype.getAll=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r={};if(this.data)throw b.err(f+"#getAll")(500,d);if(!e.length||1===e.length&&b.isObject(e[0]))return this.getData(),this;e.length&&b.isObject(e[e.length-1])&&(r=e[e.length-1],e.pop());var i=this.collection.getIndex(r.index);return this.data=[],e.forEach(function(e){t.data=t.data.concat(i.get(e))}),this},Query.prototype.getData=function(){return this.data||(this.data=this.collection.index.getAll()),this.data},Query.prototype.like=function(e,t){return new RegExp("^"+function escape(e){return e.replace(v,"\\$1")}(e).replace(y,".*").replace(g,".")+"$",t)},Query.prototype.limit=function(e){if(!b.isNumber(e))throw b.err(f+"#limit","num")(400,"number",e);var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this},Query.prototype.map=function(e,t){return this.data=this.getData().map(e,t),this},Query.prototype.mapCall=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return this.data=this.getData().map(function(e){return e[t].apply(e,n)}),this},Query.prototype.run=function(){var e=this.data;return this.data=null,e},Query.prototype.skip=function(e){if(!b.isNumber(e))throw b.err(f+"#skip","num")(400,"number",e);var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this},Query.ops={"=":function(e,t){return e==t},"==":function(e,t){return e==t},"===":function(e,t){return e===t},"!=":function(e,t){return e!=t},"!==":function(e,t){return e!==t},">":function(e,t){return t<e},">=":function(e,t){return t<=e},"<":function(e,t){return e<t},"<=":function(e,t){return e<=t},isectEmpty:function(e,t){return!b.intersection(e||[],t||[]).length},isectNotEmpty:function(e,t){return b.intersection(e||[],t||[]).length},in:function(e,t){return-1!==t.indexOf(e)},notIn:function(e,t){return-1===t.indexOf(e)},contains:function(e,t){return-1!==(e||[]).indexOf(t)},notContains:function(e,t){return-1===(e||[]).indexOf(t)}},Query}(p),R="belongsTo",x="hasMany",S="hasOne",_="Relation",A=function(){function Relation(e,t){void 0===t&&(t={}),this.TYPE_NAME=_,t.type=this.constructor.TYPE_NAME,this.validateOptions(e,t),"object"==typeof e&&(this.relatedMapper=e),b.fillIn(this,t)}return Object.defineProperty(Relation.prototype,"canAutoAddLinks",{get:function(){return void 0===this.add||!!this.add},enumerable:!0,configurable:!0}),Object.defineProperty(Relation.prototype,"relatedCollection",{get:function(){return this.mapper.datastore.getCollection(this.relation)},enumerable:!0,configurable:!0}),Relation.prototype.validateOptions=function(e,t){var n="new "+_,r=t.localField;if(!r)throw b.err(n,"opts.localField")(400,"string",r);var i=t.foreignKey=t.foreignKey||t.localKey;if(!i&&(t.type===R||t.type===S))throw b.err(n,"opts.foreignKey")(400,"string",i);if(b.isString(e)){if(t.relation=e,!b.isFunction(t.getRelation))throw b.err(n,"opts.getRelation")(400,"function",t.getRelation)}else{if(!e)throw b.err(n,"related")(400,"Mapper or string",e);t.relation=e.name}},Relation.prototype.assignTo=function(e){this.name=e.name,Object.defineProperty(this,"mapper",{value:e}),e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(this),e.relationFields.push(this.localField)},Relation.prototype.canFindLinkFor=function(e){return!(!this.foreignKey&&!this.localKey)},Relation.prototype.getRelation=function(){return this.relatedMapper},Relation.prototype.getForeignKey=function(e){return b.get(e,this.mapper.idAttribute)},Relation.prototype.setForeignKey=function(e,t){e&&t&&this._setForeignKey(e,t)},Relation.prototype._setForeignKey=function(t,e){var n=this,r=this.mapper.idAttribute;b.isArray(e)||(e=[e]),e.forEach(function(e){b.set(e,n.foreignKey,b.get(t,r))})},Relation.prototype.getLocalField=function(e){return b.get(e,this.localField)},Relation.prototype.setLocalField=function(e,t){return b.set(e,this.localField,t)},Relation.prototype.getInverse=function(e){return this.inverse||this.findInverseRelation(e),this.inverse},Relation.prototype.findInverseRelation=function(t){var n=this;this.getRelation().relationList.forEach(function(e){if(e.getRelation()===t&&n.isInversedTo(e)&&n!==e)return n.inverse=e,!0})},Relation.prototype.isInversedTo=function(e){return!e.foreignKey||e.foreignKey===this.foreignKey},Relation.prototype.addLinkedRecords=function(e){var n=this,r=this.mapper.datastore;e.forEach(function(e){var t=n.getLocalField(e);b.isFunction(n.add)?t=n.add(r,n,e):t&&(t=n.linkRecord(e,t)),(!t||b.isArray(t)&&!t.length)&&n.canFindLinkFor(e)&&(t=n.findExistingLinksFor(e)),t&&n.setLocalField(e,t)})},Relation.prototype.removeLinkedRecords=function(e,t){var n=this.localField;t.forEach(function(e){b.set(e,n,void 0)})},Relation.prototype.linkRecord=function(e,t){var n=b.get(t,this.mapper.idAttribute);void 0===n?-1===this.relatedCollection.unsaved().indexOf(t)&&this.canAutoAddLinks&&(t=this.relatedCollection.add(t)):t!==this.relatedCollection.get(n)&&(this.setForeignKey(e,t),this.canAutoAddLinks&&(t=this.relatedCollection.add(t)));return t},Relation.prototype.findExistingLinksByForeignKey=function(e){var t;if(null!=e)return this.relatedCollection.filter(((t={})[this.foreignKey]=e,t))},Relation.prototype.ensureLinkedDataHasProperType=function(e,t){var n=this.getRelation(),r=this.getLocalField(e);(!b.isArray(r)||r.length&&!n.is(r[0]))&&r&&!n.is(r)&&b.set(e,this.localField,n.createRecord(r,t))},Relation.prototype.isRequiresParentId=function(){return!1},Relation.prototype.isRequiresChildId=function(){return!1},Relation.prototype.createChildRecord=function(t,e,n){var r=this;return this.setForeignKey(t,e),this.createLinked(e,n).then(function(e){r.setLocalField(t,e)})},Relation.prototype.createLinked=function(e,t){var n=b.isArray(e)?"createMany":"create";return this.getRelation()[n](e,t)},Relation}();function superMethod(n,r){var e,i=n.datastore;return(null===(e=i)||void 0===e?void 0:e[r])?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i[r].apply(i,__spreadArrays([n.name],e))}:n[r].bind(n)}var w="creating",M="noValidate",k="keepChangeHistory",E="previous",I=function(s){function Record(e,t){var n;void 0===e&&(e={}),void 0===t&&(t={});var r=s.call(this)||this,i=r._set,o=r.constructor.mapper;i(w,!0),i(M,!!t.noValidate),i(k,void 0===t.keepChangeHistory?!o||o.keepChangeHistory:t.keepChangeHistory);var a=o?b.get(e,o.idAttribute):void 0;return void 0!==a&&b.set(r,o.idAttribute,a),b.fillIn(r,e),i(w,!1),void 0!==t.validateOnSet?i(M,!t.validateOnSet):void 0!==(null===(n=o)||void 0===n?void 0:n.validateOnSet)?i(M,!o.validateOnSet):i(M,!1),i(E,o?o.toJSON(e):b.plainCopy(e)),r}return __extends(Record,s),Record.prototype._mapper=function(){var e=this.constructor.mapper;if(!e)throw b.err("Record#_mapper","")(404,"mapper");return e},Record.prototype.afterLoadRelations=function(e,t){},Record.prototype.beforeLoadRelations=function(e,t){},Record.prototype.changeHistory=function(){return(this._get("history")||[]).slice()},Record.prototype.changes=function(e){return void 0===e&&(e={}),b.diffObjects("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},Record.prototype.commit=function(e){this._set("changed"),this._set("changing",!1),this._set("history",[]),this._set("previous",this.toJSON(e))},Record.prototype.destroy=function(e){void 0===e&&(e={});var t=this._mapper();return superMethod(t,"destroy")(b.get(this,t.idAttribute),e)},Record.prototype.get=function(e){return b.get(this,e)},Record.prototype.hasChanges=function(e){return!!(this._get("changed")||[]).length||b.areDifferent("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},Record.prototype.isNew=function(e){return void 0===b.get(this,this._mapper().idAttribute)},Record.prototype.isValid=function(e){return!this._mapper().validate(this,e)},Record.prototype.removeInverseRelation=function(e,t,n,r){var i=this;if(n.type===S)C(e,n.localField,void 0);else if(n.type===x){var o=b.get(e,n.localField);void 0===t?b.remove(o,function(e){return e===i}):b.remove(o,function(e){return e===i||t===b.get(e,r)})}},Record.prototype.setupInverseRelation=function(e,t,n,r){var i=this;if(n.type===S)C(e,n.localField,this);else if(n.type===x){var o=b.get(e,n.localField);void 0===t?b.noDupeAdd(o,this,function(e){return e===i}):b.noDupeAdd(o,this,function(e){return e===i||t===b.get(e,r)})}},Record.prototype.loadRelations=function(e,l){var t,c=this;void 0===e&&(e=[]),void 0===l&&(l={});var p=this._mapper();return b.isString(e)&&(e=[e]),l.with=e,b._(l,p),l.adapter=p.getAdapterName(l),t=l.op="beforeLoadRelations",b.resolve(this[t](e,l)).then(function(){t=l.op="loadRelations",p.dbg(t,c,e,l);var s,u=[];return b.forEachRelation(p,l,function(t,e){var n,r,i,o=t.getRelation();if(e.raw=!1,b.isFunction(t.load))s=t.load(p,t,c,l);else if("hasMany"===t.type||"hasOne"===t.type)t.foreignKey?s=superMethod(o,"findAll")((n={},n[t.foreignKey]=b.get(c,p.idAttribute),n),e).then(function(e){return"hasOne"===t.type?e.length?e[0]:void 0:e}):t.localKeys?s=superMethod(o,"findAll")({where:(r={},r[o.idAttribute]={in:b.get(c,t.localKeys)},r)}):t.foreignKeys&&(s=superMethod(o,"findAll")({where:(i={},i[t.foreignKeys]={contains:b.get(c,p.idAttribute)},i)},l));else if("belongsTo"===t.type){var a=b.get(c,t.foreignKey);b.isSorN(a)&&(s=superMethod(o,"find")(a,e))}s&&(s=s.then(function(e){t.setLocalField(c,e)}),u.push(s))}),Promise.all(u)}).then(function(){return t=l.op="afterLoadRelations",b.resolve(c[t](e,l)).then(function(){return c})})},Record.prototype.previous=function(e){return e?this._get("previous."+e):this._get("previous")},Record.prototype.revert=function(n){var r=this;void 0===n&&(n={});var i=this._get("previous");n.preserve=n.preserve||[],b.forOwn(this,function(e,t){t!==r._mapper().idAttribute&&!i.hasOwnProperty(t)&&r.hasOwnProperty(t)&&-1===n.preserve.indexOf(t)&&delete r[t]}),b.forOwn(i,function(e,t){-1===n.preserve.indexOf(t)&&(r[t]=e)}),this.commit()},Record.prototype.save=function(n){var r=this;void 0===n&&(n={});var e=this._mapper(),t=b.get(this,e.idAttribute),i=this,o=function(e){var t=n.raw?e.data:e;return t&&(b.deepMixIn(r,t),r.commit()),e};if(void 0===t)return superMethod(e,"create")(i,n).then(o);if(n.changesOnly){var a=this.changes(n);i={},b.fillIn(i,a.added),b.fillIn(i,a.changed)}return superMethod(e,"update")(t,i,n).then(o)},Record.prototype.set=function(e,t,n){b.isObject(e)&&(n=t),(n=n||{}).silent&&this._set("silent",!0),b.set(this,e,t),this._get("eventId")||this._set("silent")},Record.prototype.toJSON=function(e){var t=this.constructor.mapper;if(t)return t.toJSON(this,e);var n={};return b.forOwn(this,function(e,t){n[t]=b.plainCopy(e)}),n},Record.prototype.unset=function(e,t){this.set(e,void 0,t)},Record.prototype.validate=function(e){return this._mapper().validate(this,e)},Record.creatingPath=w,Record.noValidatePath=M,Record.keepChangeHistoryPath=k,Record.previousPath=E,Record}(c);function insertAt(e,t,n){return e.splice(t,0,n),e}function removeAt(e,t){return e.splice(t,1),e}function binarySearch(e,t,n){for(var r,i,o,a,s,u=0,l=e.length;u<l;){if(o=t,a=e[i=(u+l)/2|0],s=n,0===(r=o===a?0:(s&&(o=s(o),a=s(a)),null===o&&null===a||void 0===o&&void 0===a?-1:null==o?-1:null==a?1:o<a?-1:a<o?1:0)))return{found:!0,index:i};r<0?l=i:u=i+1}return{found:!1,index:l}}b.eventify(I.prototype,function(){return this._get("events")},function(e){this._set("events",e)});var F=function(){function Index(e,t){if(void 0===e&&(e=[]),void 0===t&&(t={}),!b.isArray(e))throw new Error("fieldList must be an array.");this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}return Index.prototype.set=function(e,t){b.isArray(e)||(e=[e]);var n=e.shift()||void 0,r=binarySearch(this.keys,n);if(0===e.length)if(r.found){var i=binarySearch(this.values[r.index],t,this.hashCode);i.found||insertAt(this.values[r.index],i.index,t)}else insertAt(this.keys,r.index,n),insertAt(this.values,r.index,[t]);else if(r.found)this.values[r.index].set(e,t);else{insertAt(this.keys,r.index,n);var o=new Index([],{hashCode:this.hashCode});o.set(e,t),insertAt(this.values,r.index,o)}},Index.prototype.get=function(e){b.isArray(e)||(e=[e]);var t=e.shift()||void 0,n=binarySearch(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index].slice():[]:n.found?this.values[n.index].get(e):[]},Index.prototype.getAll=function(e){void 0===e&&(e={});var t=[],n=this.values;if("desc"===e.order)for(var r=n.length-1;0<=r;r--){t=(a=n[r]).isIndex?t.concat(a.getAll(e)):t.concat(a)}else for(var i=0,o=n;i<o.length;i++){var a;t=(a=o[i]).isIndex?t.concat(a.getAll(e)):t.concat(a)}return t},Index.prototype.visitAll=function(t,n){this.values.forEach(function(e){e.isIndex?e.visitAll(t,n):e.forEach(t,n)})},Index.prototype.between=function(e,t,n){void 0===n&&(n={}),b.isArray(e)||(e=[e]),b.isArray(t)||(t=[t]),b.fillIn(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var r=this._between(e,t,n);return n.limit?r.slice(n.offset,n.limit+n.offset):r.slice(n.offset)},Index.prototype._between=function(e,t,n){var r,i=[],o=e.shift(),a=t.shift();if(r=void 0!==o?binarySearch(this.keys,o):{found:!1,index:0},0===e.length){r.found&&!1===n.leftInclusive&&(r.index+=1);for(var s=r.index;s<this.keys.length;s+=1){if(void 0!==a)if(n.rightInclusive){if(this.keys[s]>a)break}else if(this.keys[s]>=a)break;if(i=this.values[s].isIndex?i.concat(this.values[s].getAll()):i.concat(this.values[s]),n.limit&&i.length>=n.limit+n.offset)break}}else for(s=r.index;s<this.keys.length;s+=1){var u=this.keys[s];if(a<u)break;if(i=this.values[s].isIndex?u===o?i.concat(this.values[s]._between(b.copy(e),t.map(function(){}),n)):u===a?i.concat(this.values[s]._between(e.map(function(){}),b.copy(t),n)):i.concat(this.values[s].getAll()):i.concat(this.values[s]),n.limit&&i.length>=n.limit+n.offset)break}return n.limit?i.slice(0,n.limit+n.offset):i},Index.prototype.peek=function(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},Index.prototype.clear=function(){this.keys=[],this.values=[]},Index.prototype.insertRecord=function(t){var e=this.fieldList.map(function(e){return b.isFunction(e)?e(t)||void 0:t[e]||void 0});this.set(e,t)},Index.prototype.removeRecord=function(i){var o,a=this,s=void 0!==this.hashCode(i);return this.values.forEach(function(e,t){if(e.isIndex){if(e.removeRecord(i))return 0===e.keys.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}else{var n={};if(void 0!==a.keys[t]&&s)s&&(n=binarySearch(e,i,a.hashCode));else for(var r=e.length-1;0<=r;r--)if(e[r]===i){n={found:!0,index:r};break}if(n.found)return removeAt(e,n.index),0===e.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}}),o?i:void 0},Index.prototype.updateRecord=function(e){void 0!==this.removeRecord(e)&&this.insertRecord(e)},Index}(),j=I.noValidatePath,L="Collection",P={commitOnMerge:!0,emitRecordEvents:!0,idAttribute:"id",onConflict:"merge"},K=function(i){function Collection(e,t){void 0===e&&(e={}),void 0===t&&(t={});var n=i.call(this,t)||this;n.indexes={},n._added={},e&&!b.isArray(e)&&(t=e,e=[]),b.isString(t)&&(t={idAttribute:t}),b.fillIn(n,t),b.fillIn(n,b.copy(P)),n.queryClass||(n.queryClass=m);var r=n.recordId();return n.index=new F([r],{hashCode:function(e){return b.get(e,r)}}),(b.isObject(e)||b.isArray(e)&&e.length)&&n.add(e),n}return __extends(Collection,i),Collection.prototype._onRecordEvent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.emitRecordEvents&&this.emit.apply(this,e)},Collection.prototype.add=function(e,o){var a=this;void 0===o&&(o={}),b._(o,this),e=this.beforeAdd(e,o)||e;var t=!1,s=this.recordId();if(!b.isArray(e)){if(!b.isObject(e))throw b.err(L+"#add","records")(400,"object or array",e);e=[e],t=!0}e=e.map(function(n){var e=a.recordId(n),r=void 0===e?e:a.get(e);if(n===r)return r;if(r){var t=o.onConflict||a.onConflict;if("merge"!==t&&"replace"!==t&&"skip"!==t)throw b.err(L+"#add","opts.onConflict")(400,"one of (merge, replace, skip)",t,!0);var i=r._get(j);o.noValidate&&r._set(j,!0),"merge"===t?b.deepMixIn(r,n):"replace"===t&&(b.forOwn(r,function(e,t){t!==s&&void 0===n[t]&&(r[t]=void 0)}),r.set(n)),o.noValidate&&r._set(j,i),n=r,o.commitOnMerge&&b.isFunction(n.commit)&&n.commit(),a.updateIndexes(n)}else n=a.mapper?a.mapper.createRecord(n,o):n,a.index.insertRecord(n),b.forOwn(a.indexes,function(e,t){e.insertRecord(n)}),n&&b.isFunction(n.on)&&n.on("all",a._onRecordEvent,a);return n});var n=t?e[0]:e;return o.silent||this.emit("add",n),this.afterAdd(e,o,n)||n},Collection.prototype.afterAdd=function(e,t,n){return null},Collection.prototype.afterRemove=function(e,t,n){return null},Collection.prototype.afterRemoveAll=function(e,t,n){return null},Collection.prototype.beforeAdd=function(e,t){return null},Collection.prototype.beforeRemove=function(e,t){return null},Collection.prototype.beforeRemoveAll=function(e,t){return null},Collection.prototype.between=function(e,t,n){return this.query().between(e,t,n).run()},Collection.prototype.createIndex=function(e,t,n){var r=this;void 0===n&&(n={}),b.isString(e)&&void 0===t&&(t=[e]),n.hashCode=n.hashCode||function(e){return r.recordId(e)};var i=this.indexes[e]=new F(t,n);this.index.visitAll(i.insertRecord,i)},Collection.prototype.filter=function(e,t){return this.query().filter(e,t).run()},Collection.prototype.forEach=function(e,t){this.index.visitAll(e,t)},Collection.prototype.get=function(e){var t=void 0===e?[]:this.query().get(e).run();return t.length?t[0]:void 0},Collection.prototype.getAll=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(e=this.query()).getAll.apply(e,t).run()},Collection.prototype.getIndex=function(e){var t=e?this.indexes[e]:this.index;if(!t)throw b.err(L+"#getIndex",e)(404,"index");return t},Collection.prototype.limit=function(e){return this.query().limit(e).run()},Collection.prototype.map=function(t,n){var r=[];return this.index.visitAll(function(e){r.push(t.call(n,e))}),r},Collection.prototype.mapCall=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var r=[];return this.index.visitAll(function(e){r.push(e[t].apply(e,n))}),r},Collection.prototype.prune=function(e){return this.removeAll(this.unsaved(),e)},Collection.prototype.query=function(){return new this.queryClass(this)},Collection.prototype.recordId=function(e){return e?b.get(e,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute},Collection.prototype.reduce=function(e,t){return this.getAll().reduce(e,t)},Collection.prototype.remove=function(e,t){void 0===t&&(t={}),this.beforeRemove(e,t);var n=b.isSorN(e)?this.get(e):e;return b.isObject(n)&&(n=this.index.removeRecord(n))&&(b.forOwn(this.indexes,function(e,t){e.removeRecord(n)}),b.isFunction(n.off)&&n.off("all",this._onRecordEvent,this),t.silent||this.emit("remove",n)),this.afterRemove(e,t,n)||n},Collection.prototype.removeAll=function(e,t){var n=this;void 0===t&&(t={}),this.beforeRemoveAll(e,t);var r=b.isArray(e)?e.slice():this.filter(e),i=b.plainCopy(t);return i.silent=!0,r=r.map(function(e){return n.remove(e,i)}).filter(function(e){return e}),t.silent||this.emit("remove",r),this.afterRemoveAll(e,t,r)||r},Collection.prototype.skip=function(e){return this.query().skip(e).run()},Collection.prototype.toJSON=function(e){return this.mapCall("toJSON",e)},Collection.prototype.unsaved=function(e){return this.index.get()},Collection.prototype.updateIndex=function(e,t){void 0===t&&(t={}),this.getIndex(t.index).updateRecord(e)},Collection.prototype.updateIndexes=function(t){this.index.updateRecord(t),b.forOwn(this.indexes,function(e){return e.updateRecord(t)})},Collection}(p),D=function(e){function TsDataError(){return null!==e&&e.apply(this,arguments)||this}return __extends(TsDataError,e),TsDataError}(Error),T={array:b.isArray,boolean:b.isBoolean,integer:b.isInteger,null:b.isNull,number:b.isNumber,object:b.isObject,string:b.isString};function segmentToString(e,t){var n="";return e&&(b.isNumber(e)?n+="["+e+"]":n+=t?"."+e:""+e),n}function makeError(e,t,n){return{expected:t,actual:""+e,path:function makePath(e){void 0===e&&(e={});var t="";return(e.path||[]).forEach(function(e){t+=segmentToString(e,t)}),t+=segmentToString(e.prop,t)}(n)}}function addError(e,t,n,r){r.push(makeError(e,t,n))}function maxLengthCommon(e,t,n,r){var i=n[e];if(t.length>i)return makeError(t.length,"length no more than "+i,r)}function minLengthCommon(e,t,n,r){var i=n[e];if(t.length<i)return makeError(t.length,"length no less than "+i,r)}var N={allOf:function(t,e,n){var r=[];return e.allOf.forEach(function(e){r=r.concat(U(t,e,n)||[])}),r.length?r:void 0},anyOf:function(n,e,r){var i=!1,o=[];return e.anyOf.forEach(function(e){var t=U(n,e,r);t?o=o.concat(t):i=!0}),i?void 0:o},dependencies:function(e,t,n){},enum:function(t,e,n){var r=e.enum;if(-1===b.findIndex(r,function(e){return b.deepEqual(e,t)}))return makeError(t,"one of ("+r.join(", ")+")",n)},items:function(e,t,n){void 0===n&&(n={});for(var r=t.items,i=[],o=b.isArray(r),a=e.length,s=0;s<a;s++)o&&(r=t.items[s]),n.prop=s,i=i.concat(U(e[s],r,n)||[]);return i.length?i:void 0},maximum:function(e,t,n){var r=t.maximum,i=t.exclusiveMaximum;if(typeof e==typeof r&&!(i?e<r:e<=r))return makeError(e,i?"no more than nor equal to "+r:"no more than "+r,n)},maxItems:function(e,t,n){if(b.isArray(e))return maxLengthCommon("maxItems",e,t,n)},maxLength:function(e,t,n){return maxLengthCommon("maxLength",e,t,n)},maxProperties:function(e,t,n){if(b.isObject(e)){var r=t.maxProperties,i=Object.keys(e).length;return r<i?makeError(i,"no more than "+r+" properties",n):void 0}},minimum:function(e,t,n){var r=t.minimum,i=t.exclusiveMinimum;if(typeof e==typeof r&&!(i?r<e:r<=e))return makeError(e,i?"no less than nor equal to "+r:"no less than "+r,n)},minItems:function(e,t,n){if(b.isArray(e))return minLengthCommon("minItems",e,t,n)},minLength:function(e,t,n){return minLengthCommon("minLength",e,t,n)},minProperties:function(e,t,n){if(b.isObject(e)){var r=t.minProperties,i=Object.keys(e).length;return i<r?makeError(i,"no more than "+r+" properties",n):void 0}},multipleOf:function(e,t,n){var r=t.multipleOf;if(b.isNumber(e)&&e/r%1!=0)return makeError(e,"multipleOf "+r,n)},not:function(e,t,n){if(!U(e,t.not,n))return makeError("succeeded","should have failed",n)},oneOf:function(n,e,r){var i=!1,o=[];return e.oneOf.forEach(function(e){var t=U(n,e,r);if(t)o=o.concat(t);else{if(i)return o=[makeError("valid against more than one","valid against only one",r)],i=!1;i=!0}}),i?void 0:o},pattern:function(e,t,n){var r=t.pattern;if(b.isString(e)&&!e.match(r))return makeError(e,r,n)},properties:function(i,e,o){if(void 0===o&&(o={}),!b.isArray(i)){var t=void 0===e.additionalProperties||e.additionalProperties,a=[],n=e.properties||{},r=e.patternProperties||{},s=[];b.forOwn(n,function(e,t){o.prop=t,s=s.concat(U(i[t],e,o)||[]),a.push(t)});var u=b.omit(i,a);b.forOwn(r,function(n,r){b.forOwn(u,function(e,t){t.match(r)&&(o.prop=t,s=s.concat(U(i[t],n,o)||[]),a.push(t))})});var l=Object.keys(b.omit(i,a));if(!1===t){if(l.length){var c=o.prop;o.prop="",addError("extra fields: "+l.join(", "),"no extra fields",o,s),o.prop=c}}else b.isObject(t)&&l.forEach(function(e){o.prop=e,s=s.concat(U(i[e],t,o)||[])});return s.length?s:void 0}},required:function(n,e,r){void 0===r&&(r={});var t=e.required,i=[];return r.existingOnly||t.forEach(function(e){if(void 0===b.get(n,e)){var t=r.prop;r.prop=e,addError(void 0,"a value",r,i),r.prop=t}}),i.length?i:void 0},type:function(t,n,r){var i,e=n.type;if(b.isString(e)&&(e=[e]),e.forEach(function(e){if(T[e](t,n,r))return i=e,!1}),!i)return makeError(null!=t?typeof t:""+t,"one of ("+e.join(", ")+")",r);var o=W[i];return o?o(t,n,r):void 0},uniqueItems:function(e,t,n){var r;if((null===(r=e)||void 0===r?void 0:r.length)&&t.uniqueItems){var i=void 0,o=void 0,a=void 0;for(o=e.length-1;0<o;o--)for(i=e[o],a=o-1;0<=a;a--)if(b.deepEqual(i,e[a]))return makeError(i,"no duplicates",n)}}};function runOps(e,t,n,r){var i=[];return e.forEach(function(e){void 0!==n[e]&&(i=i.concat(N[e](t,n,r)||[]))}),i.length?i:void 0}var Q=["enum","type","allOf","anyOf","oneOf","not"],q=["items","maxItems","minItems","uniqueItems"],H=["multipleOf","maximum","minimum"],B=["maxProperties","minProperties","required","properties","dependencies"],J=["maxLength","minLength","pattern"],U=function(e,t,n){void 0===n&&(n={});var r,i=[];n.ctx=n.ctx||{value:e,schema:t};var o=n.prop;if(void 0!==t){if(!b.isObject(t))throw b.err("Schema#validate")(500,'Invalid schema at path: "'+n.path+'"');return void 0===n.path&&(n.path=[]),void 0!==n.prop&&(r=!0,n.path.push(n.prop),n.prop=void 0),t.extends&&(i=b.isFunction(t.extends.validate)?i.concat(t.extends.validate(e,n)||[]):i.concat(U(e,t.extends,n)||[])),void 0===e?(!0!==t.required||n.existingOnly||addError(e,"a value",n,i),r&&(n.path.pop(),n.prop=o),i.length?i:void 0):(i=i.concat(runOps(Q,e,t,n)||[]),r&&(n.path.pop(),n.prop=o),i.length?i:void 0)}},V="changing",$="changed",G="history",Y="eventId",W={array:function(e,t,n){return runOps(q,e,t,n)},integer:function(e,t,n){return W.numeric(e,t,n)},number:function(e,t,n){return W.numeric(e,t,n)},numeric:function(e,t,n){return runOps(H,e,t,n)},object:function(e,t,n){return runOps(B,e,t,n)},string:function(e,t,n){return runOps(J,e,t,n)}},z=function(t){function Schema(e){void 0===e&&(e={});var r=t.call(this)||this;return b.fillIn(r,e),"object"===r.type?(r.properties=r.properties||{},b.forOwn(r.properties,function(e,t){e instanceof Schema||(r.properties[t]=new Schema(e))})):"array"!==r.type||!r.items||r.items instanceof Schema||(r.items=new Schema(r.items)),!r.extends||r.extends instanceof Schema||(r.extends=new Schema(r.extends)),["allOf","anyOf","oneOf"].forEach(function(n){r[n]&&r[n].forEach(function(e,t){e instanceof Schema||(r[n][t]=new Schema(e))})}),r}return __extends(Schema,t),Schema.prototype.apply=function(n,r){var i=this;void 0===r&&(r={}),r.getter=r.getter||"_get",r.setter=r.setter||"_set",r.unsetter=r.unsetter||"_unset",r.track=r.track||this.track;var e=this.properties||{};b.forOwn(e,function(e,t){Object.defineProperty(n,t,i.makeDescriptor(t,e,r))})},Schema.prototype.applyDefaults=function(r){if(r){var e=this.properties||{},i=b.isFunction(r.set)||b.isFunction(r._set);b.forOwn(e,function(e,t){if(e.hasOwnProperty("default")&&void 0===b.get(r,t)&&(i?r.set(t,b.plainCopy(e.default),{silent:!0}):b.set(r,t,b.plainCopy(e.default))),"object"===e.type&&e.properties){if(i){var n=r._get("noValidate");r._set("noValidate",!0),b.set(r,t,b.get(r,t)||{},{silent:!0}),r._set("noValidate",n)}else b.set(r,t,b.get(r,t)||{});e.applyDefaults(b.get(r,t))}})}},Schema.prototype.makeDescriptor=function(d,o,e){var t={configurable:!0,enumerable:void 0===o.enumerable||!!o.enumerable,get:function(){return this._get(h)},set:function(a){var s=this,u=this[y],l=this[g],c=this[m];if(!u("noValidate")){var e=o.validate(a,{path:[d]});if(e){var t=new D("validation failed");throw t.errors=e,t}}if(_&&!u("creating")){var n=u(v),p=u(h),r=u(V),f=u($);r||(f=[]);var i=f.indexOf(d);p!==a&&-1===i&&f.push(d),n===a&&0<=i&&f.splice(i,1),f.length||(r=!1,c(V),c($),u(Y)&&(clearTimeout(u(Y)),c(Y))),!r&&f.length&&(l($,f),l(V,!0),l(Y,setTimeout(function(){var e,t;if(c($),c(Y),c(V),!u("silent")){var n=void 0;for(n=0;n<f.length;n++)s.emit("change:"+f[n],s,b.get(s,f[n]));var r=b.diffObjects(((e={})[d]=a,e),((t={})[d]=p,t));if(u("keepChangeHistory")){var i=b.plainCopy(r);i.timestamp=(new Date).getTime();var o=u(G);o||l(G,o=[]),o.push(i)}s.emit("change",s,r)}c("silent")},0)))}return l(h,a),a}},h="props."+d,v="previous."+d,y=e.getter,g=e.setter,m=e.unsetter,_=b.isBoolean(e.track)?e.track:o.track;if(b.isFunction(o.get)){var n=t.get;t.get=function(){return o.get.call(this,n)}}if(b.isFunction(o.set)){var r=t.set;t.set=function(e){return o.set.call(this,e,r)}}return t},Schema.prototype.pick=function(n,e){var r=this;if(void 0!==n){if("object"===this.type){var i={},t=this.properties;if(t&&b.forOwn(t,function(e,t){i[t]=e.pick(n[t])}),this.extends&&b.fillIn(i,this.extends.pick(n)),this.additionalProperties)for(var o in n)t[o]||(i[o]=b.plainCopy(n[o]));return i}return"array"===this.type?n.map(function(e){var t=r.items?r.items.pick(e):{};return r.extends&&b.fillIn(t,r.extends.pick(e)),t}):b.plainCopy(n)}},Schema.prototype.validate=function(e,t){return U(e,this,t)},Schema.ANY_OPS=Q,Schema.ARRAY_OPS=q,Schema.NUMERIC_OPS=H,Schema.OBJECT_OPS=B,Schema.STRING_OPS=J,Schema.typeGroupValidators=W,Schema.types=T,Schema.validate=U,Schema.validationKeywords=N,Schema}(p);function belongsTo(t,n){return function(e){A.belongsTo(t,n).assignTo(e)}}function hasMany(t,n){return function(e){A.hasMany(t,n).assignTo(e)}}function hasOne(t,n){return function(e){A.hasOne(t,n).assignTo(e)}}[function(e){function BelongsToRelation(){return null!==e&&e.apply(this,arguments)||this}return __extends(BelongsToRelation,e),BelongsToRelation.prototype.getForeignKey=function(e){return b.get(e,this.foreignKey)},BelongsToRelation.prototype._setForeignKey=function(e,t){b.set(e,this.foreignKey,b.get(t,this.getRelation().idAttribute))},BelongsToRelation.prototype.findExistingLinksFor=function(e){if(e){var t=b.get(e,this.foreignKey);return null!=t?this.relatedCollection.get(t):void 0}},BelongsToRelation.prototype.isRequiresParentId=function(){return!0},BelongsToRelation.prototype.createParentRecord=function(t,e){var n=this,r=this.getLocalField(t);return this.createLinked(r,e).then(function(e){n.setForeignKey(t,e)})},BelongsToRelation.prototype.createChildRecord=function(){throw new Error('"BelongsTo" relation does not support child creation as it cannot have children.')},BelongsToRelation.TYPE_NAME="belongsTo",BelongsToRelation}(A),function(o){function HasManyRelation(){return null!==o&&o.apply(this,arguments)||this}return __extends(HasManyRelation,o),HasManyRelation.prototype.validateOptions=function(e,t){o.prototype.validateOptions.call(this,e,t);var n=t.localKeys,r=t.foreignKeys,i=t.foreignKey;if(!i&&!n&&!r)throw b.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",i)},HasManyRelation.prototype.canFindLinkFor=function(e){return!!(this.foreignKey||this.foreignKeys||this.localKeys&&b.get(e,this.localKeys))},HasManyRelation.prototype.linkRecord=function(n,e){var r=this,i=this.relatedCollection,o=this.canAutoAddLinks,a=this.foreignKey,s=this.relatedCollection.unsaved();return e.map(function(e){var t=i.recordId(e);return(void 0===t&&-1===s.indexOf(e)||e!==i.get(t))&&(a&&r.setForeignKey(n,e),o&&(e=i.add(e))),e})},HasManyRelation.prototype.findExistingLinksFor=function(e){var t,n,r=b.get(e,this.mapper.idAttribute),i=this.localKeys?b.get(e,this.localKeys):null;if(void 0!==r&&this.foreignKey?n=this.findExistingLinksByForeignKey(r):this.localKeys&&i?n=this.findExistingLinksByLocalKeys(i):void 0!==r&&this.foreignKeys&&(n=this.findExistingLinksByForeignKeys(r)),null===(t=n)||void 0===t?void 0:t.length)return n},HasManyRelation.prototype.findExistingLinksByLocalKeys=function(e){var t;return this.relatedCollection.filter({where:(t={},t[this.relatedCollection.mapper.idAttribute]={in:e},t)})},HasManyRelation.prototype.findExistingLinksByForeignKeys=function(e){var t;return this.relatedCollection.filter({where:(t={},t[this.foreignKeys]={contains:e},t)})},HasManyRelation.prototype.isRequiresParentId=function(){return!!this.localKeys&&0<this.localKeys.length},HasManyRelation.prototype.isRequiresChildId=function(){return!!this.foreignKey},HasManyRelation.prototype.createParentRecord=function(t,e){var n=this,r=this.getLocalField(t),i=this.getRelation().idAttribute;return this.createLinked(r,e).then(function(e){b.set(t,n.localKeys,e.map(function(e){return b.get(e,i)}))})},HasManyRelation.prototype.createLinked=function(e,t){return this.getRelation().createMany(e,t)},HasManyRelation.TYPE_NAME="hasMany",HasManyRelation}(A),function(e){function HasOneRelation(){return null!==e&&e.apply(this,arguments)||this}return __extends(HasOneRelation,e),HasOneRelation.prototype.findExistingLinksFor=function(e,t){var n,r=b.get(t,e.idAttribute),i=this.findExistingLinksByForeignKey(r);if(null===(n=i)||void 0===n?void 0:n.length)return i[0]},HasOneRelation.prototype.isRequiresChildId=function(){return!0},HasOneRelation.TYPE_NAME="hasOne",HasOneRelation}(A)].forEach(function(n){A[n.TYPE_NAME]=function(e,t){return new n(e,t)}});var X="Mapper",Z=["beforeCreate","beforeCreateMany"],ee=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"];function makeNotify(p){return function(){for(var e,t=this,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var i=n[n.length-p],o=i.op;if(this.dbg.apply(this,__spreadArrays([o],n)),-1!==Z.indexOf(o)&&!1!==i.applyDefaults){var a=this.getSchema();if(null===(e=a)||void 0===e?void 0:e.applyDefaults){var s=n[0];b.isArray(s)||(s=[s]),s.forEach(function(e){a.applyDefaults(e)})}}if(-1!==ee.indexOf(o)&&!i.noValidate){var u=i.existingOnly;0===o.indexOf("beforeUpdate")&&void 0===i.existingOnly&&(i.existingOnly=!0);var l=this.validate(n["beforeUpdate"===o?1:0],b.pick(i,["existingOnly"]));if(i.existingOnly=u,l){var c=new D("validation failed");return c.errors=l,b.reject(c)}}(i.notify||void 0===i.notify&&this.notify)&&setTimeout(function(){t.emit.apply(t,__spreadArrays([o],n))})}}var te=makeNotify(1),ne=makeNotify(2),re={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function(e,t,n,r){return[t,e.toJSON(n,r),r]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function(e,t,n,r){return[e.toJSON(t,r),n,r]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function(t,e,n){return[e.map(function(e){return t.toJSON(e,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},ie={_adapters:{},applyDefaults:!0,applySchema:!0,defaultAdapter:"http",idAttribute:"id",keepChangeHistory:!0,notify:!0,noValidate:!1,raw:!1,validateOnSet:!0},oe=function(n){function Mapper(e){void 0===e&&(e={});var t=n.call(this)||this;if(t.lifecycleMethods=re,t.afterCount=ne,t.afterCreate=ne,t.afterCreateMany=ne,t.afterDestroy=ne,t.afterDestroyAll=ne,t.afterFind=ne,t.afterFindAll=ne,t.afterSum=ne,t.afterUpdate=ne,t.afterUpdateAll=ne,t.afterUpdateMany=ne,t.beforeCreate=te,t.beforeCreateMany=te,t.beforeCount=te,t.beforeDestroy=te,t.beforeDestroyAll=te,t.beforeFind=te,t.beforeFindAll=te,t.beforeSum=te,t.beforeUpdate=te,t.beforeUpdateAll=te,t.beforeUpdateMany=te,b.fillIn(t,e),b.fillIn(t,b.copy(ie)),!t.name)throw b.err("new "+X,"opts.name")(400,"string",t.name);return t.schema&&(t.schema.type=t.schema.type||"object",t.schema instanceof z||(t.schema=new z(t.schema||{type:"object"}))),void 0===t.recordClass&&(t.recordClass=function(e){function TiedRecord(){return null!==e&&e.apply(this,arguments)||this}return __extends(TiedRecord,e),TiedRecord}(I)),t.recordClass&&(t.recordClass.mapper=t,b.isObject(t.methods)&&b.addHiddenPropsToTarget(t.recordClass.prototype,t.methods),I.prototype.isPrototypeOf(Object.create(t.recordClass.prototype))&&t.schema&&t.schema.apply&&t.applySchema&&t.schema.apply(t.recordClass.prototype)),t}return __extends(Mapper,n),Mapper.prototype._end=function(e,t,n){if(void 0===n&&(n=!1),t.raw&&b._(e,t),n)return e;var r=t.raw?e.data:e;return r&&b.isFunction(this.wrap)&&(r=this.wrap(r,t),t.raw?e.data=r:e=r),e},Mapper.prototype.belongsTo=function(e,t){return belongsTo(e,t)(this)},Mapper.prototype.count=function(e,t){return this.crud("count",e,t)},Mapper.prototype.create=function(n,r){var i=this;void 0===n&&(n={}),void 0===r&&(r={});var t=n,o={},a={};return b._(r,this),r.adapter=this.getAdapterName(r),r.op="beforeCreate",this._runHook(r.op,n,r).then(function(e){return r.with=r.with||[],i._createParentRecordIfRequired(e,r)}).then(function(e){o=e}).then(function(){return r.op="create",i._invokeAdapterMethod(r.op,n,r)}).then(function(e){a=e}).then(function(){var e=r.raw?a.data:a;return i._createOrAssignChildRecordIfRequired(e,{opts:r,parentRelationMap:o,originalProps:n})}).then(function(e){return i._commitChanges(t,e)}).then(function(e){r.raw?a.data=e:a=e;var t=i._end(a,r);return r.op="afterCreate",i._runHook(r.op,n,r,t)})},Mapper.prototype._commitChanges=function(e,n){var r=this;return b.isArray(e)?e.map(function(e,t){return r._commitChanges(e,n[t])}):(b.set(e,n,{silent:!0}),b.isFunction(e.commit)&&e.commit(),e)},Mapper.prototype.createInstance=function(e,t){return this.createRecord(e,t)},Mapper.prototype._createParentRecordIfRequired=function(n,e){var r=[],i=[];return b.forEachRelation(this,e,function(e,t){e.isRequiresParentId()&&e.getLocalField(n)&&(t.raw=!1,i.push(e),r.push(e.createParentRecord(n,t)))}),Promise.all(r).then(function(r){return i.reduce(function(e,t,n){return t.setLocalField(e,r[n]),e},{})})},Mapper.prototype._createOrAssignChildRecordIfRequired=function(i,o){var a=[];return b.forEachRelation(this,o.opts,function(e,t){var n=e.getLocalField(o.originalProps);if(n)if(t.raw=!1,e.isRequiresChildId())a.push(e.createChildRecord(i,n,t));else if(e.isRequiresParentId()){var r=e.getLocalField(o.parentRelationMap);r&&e.setLocalField(i,r)}}),Promise.all(a).then(function(){return i})},Mapper.prototype.createMany=function(e,n){var l=this;void 0===e&&(e=[]),void 0===n&&(n={});var r,t=e;return b._(n,this),n.adapter=this.getAdapterName(n),n.op="beforeCreateMany",this._runHook(n.op,e,n).then(function(a){var s={};n.with=n.with||[];var u=[];return b.forEachRelation(l,n,function(r,e){var t=a.map(function(e){return r.getLocalField(e)}).filter(Boolean);r.type===R&&t.length===a.length&&(e.raw=!1,u.push(r.createLinked(t,e).then(function(n){a.forEach(function(e,t){return r.setForeignKey(e,n[t])})}).then(function(e){r.setLocalField(s,e)})))}),Promise.all(u).then(function(){return n.op="createMany",l._invokeAdapterMethod(n.op,a,n)}).then(function(e){r=e}).then(function(){var o=n.raw?r.data:r;return u=[],b.forEachRelation(l,n,function(r,e){var n=a.map(function(e){return r.getLocalField(e)}).filter(Boolean);if(n.length===a.length){e.raw=!1;var t,i=r.getLocalField(s);r.type===x?l.log("warn","deep createMany of hasMany type not supported!"):r.type===S?(o.forEach(function(e,t){r.setForeignKey(e,n[t])}),t=r.getRelation().createMany(n,e).then(function(n){o.forEach(function(e,t){r.setLocalField(e,n[t])})})):r.type===R&&i&&i.length===o.length&&o.forEach(function(e,t){r.setLocalField(e,i[t])}),t&&u.push(t)}}),Promise.all(u).then(function(){return l._commitChanges(t,o)})})}).then(function(e){n.raw?r.data=e:r=e;var t=l._end(r,n);return n.op="afterCreateMany",l._runHook(n.op,e,n,t)})},Mapper.prototype.createRecord=function(t,n){var r=this;if(void 0===t&&(t={}),b.isArray(t))return t.map(function(e){return r.createRecord(e,n)});if(!b.isObject(t))throw b.err(X+"#createRecord","props")(400,"array or object",t);this.relationList&&this.relationList.forEach(function(e){e.ensureLinkedDataHasProperType(t,n)});var e=this.recordClass;return!e||t instanceof e?t:new e(t,n)},Mapper.prototype.crud=function(n){for(var r=this,i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];var o=this.lifecycleMethods[n];if(!o)throw b.err(X+"#crud",n)(404,"method");var a,t=""+n.charAt(0).toUpperCase()+n.substr(1),s="before"+t,u="after"+t;o.defaults.forEach(function(e,t){void 0===i[t]&&(i[t]=b.copy(e))});var l=i[i.length-1];b._(l,this);var c=l.adapter=this.getAdapterName(l);return a=l.op=s,b.resolve(this[a].apply(this,i)).then(function(e){var t;return void 0!==i[o.beforeAssign]&&(i[o.beforeAssign]=void 0===e?i[o.beforeAssign]:e),a=l.op=n,i=o.adapterArgs?o.adapterArgs.apply(o,__spreadArrays([r],i)):i,r.dbg.apply(r,__spreadArrays([a],i)),b.resolve((t=r.getAdapter(c))[a].apply(t,__spreadArrays([r],i)))}).then(function(t){var e=/find/.test(a)||l.noValidate,n=Object.assign({},l,{noValidate:e});return t=r._end(t,n,!!o.skip),i.push(t),a=l.op=u,b.resolve(r[a].apply(r,i)).then(function(e){return void 0===e?t:e})})},Mapper.prototype.destroy=function(e,t){return this.crud("destroy",e,t)},Mapper.prototype.destroyAll=function(e,t){return this.crud("destroyAll",e,t)},Mapper.prototype.find=function(e,t){return this.crud("find",e,t)},Mapper.prototype.findAll=function(e,t){return this.crud("findAll",e,t)},Mapper.prototype.getAdapter=function(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw b.err(X+"#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},Mapper.prototype.getAdapterName=function(e){return void 0===e&&(e={}),b.isString(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter},Mapper.prototype.getAdapters=function(){return this._adapters},Mapper.prototype.getSchema=function(){return this.schema},Mapper.prototype.hasMany=function(e,t){return hasMany(e,t)(this)},Mapper.prototype.hasOne=function(e,t){return hasOne(e,t)(this)},Mapper.prototype.is=function(e){var t=this.recordClass;return!!t&&e instanceof t},Mapper.prototype.registerAdapter=function(e,t,n){void 0===n&&(n={}),this.getAdapters()[e]=t,(!0===n||n.default)&&(this.defaultAdapter=e)},Mapper.prototype._runHook=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=0===e.indexOf("after")?t.length-1:0;return b.resolve(this[e].apply(this,t)).then(function(e){return void 0===e?t[r]:e})},Mapper.prototype._invokeAdapterMethod=function(e,t,n){var r,i=this,o={with:n.pass||[]};return this.dbg(n.op,t,n),r=b.isArray(t)?t.map(function(e){return i.toJSON(e,o)}):this.toJSON(t,o),this.getAdapter(n.adapter)[e](this,r,n)},Mapper.prototype.sum=function(e,t,n){return this.crud("sum",e,t,n)},Mapper.prototype.toJSON=function(e,t){var r,n=this;if(void 0===t&&(t={}),b.isArray(e))return e.map(function(e){return n.toJSON(e,t)});r=e;var i=(this?this.relationFields:[])||[],o={};if(this&&this.schema)o=this.schema.pick(r);else for(var a in r)-1===i.indexOf(a)&&(o[a]=b.plainCopy(r[a]));return this&&t.withAll&&(t.with=i.slice()),this&&t.with&&(b.isString(t.with)&&(t.with=[t.with]),b.forEachRelation(this,t,function(t,n){var e=t.getLocalField(r);e&&(b.isArray(e)?t.setLocalField(o,e.map(function(e){return t.getRelation().toJSON(e,n)})):t.setLocalField(o,t.getRelation().toJSON(e,n)))})),o},Mapper.prototype.update=function(e,t,n){return this.crud("update",e,t,n)},Mapper.prototype.updateAll=function(e,t,n){return this.crud("updateAll",e,t,n)},Mapper.prototype.updateMany=function(e,t){return this.crud("updateMany",e,t)},Mapper.prototype.validate=function(e,t){void 0===t&&(t={});var n=this.getSchema();if(n){var r=b.pick(t,["existingOnly"]);if(b.isArray(e)){var i=e.map(function(e){return n.validate(e,b.pick(r,["existingOnly"]))});return i.some(Boolean)?i:void 0}return n.validate(e,r)}},Mapper.prototype.wrap=function(e,t){return this.createRecord(e,t)},Mapper.prototype.defineRelations=function(){var i=this;b.forOwn(this.relations,function(e,r){b.forOwn(e,function(e,n){b.isObject(e)&&(e=[e]),e.forEach(function(e){var t=i.datastore.getMapperByName(n)||n;if(e.getRelation=function(){return i.datastore.getMapper(n)},"function"!=typeof A[r])throw b.err(X,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",r,!0);i[r](t,e)})})})},Mapper}(p),ae="Container",se=["count","create","createMany","createRecord","destroy","destroyAll","find","findAll","getSchema","is","sum","toJSON","update","updateAll","updateMany","validate"],ue=function(n){function Container(e){void 0===e&&(e={});var t=n.call(this)||this;return Object.defineProperties(t,{_adapters:{value:{}},_mappers:{value:{}},mapperClass:{value:void 0,writable:!0}}),b.fillIn(t,e),t.mapperDefaults=t.mapperDefaults||{},t.mapperClass=t.mapperClass||oe,t}return __extends(Container,n),Container.prototype._onMapperEvent=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=t.shift();this.emit.apply(this,__spreadArrays([r,e],t))},Container.prototype.as=function(r){var e={},i=this;return se.forEach(function(n){e[n]={writable:!0,value:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i[n].apply(i,__spreadArrays([r],e))}}}),e.getMapper={writable:!0,value:function(){return i.getMapper(r)}},Object.create(this,e)},Container.prototype.defineMapper=function(n,e){var r=this;if(b.isObject(n)&&(n=(e=n).name),!b.isString(n))throw b.err(ae+"#defineMapper","name")(400,"string",n);(e=e||{}).name=n,e.relations=e.relations||{};var t=e.mapperClass||this.mapperClass;delete e.mapperClass,b.fillIn(e,this.mapperDefaults);var i=this._mappers[n]=new t(e);return i.relations=i.relations||{},i.name=n,i._adapters=this.getAdapters(),i.datastore=this,i.on("all",function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r._onMapperEvent.apply(r,__spreadArrays([n],e))}),i.defineRelations(),i},Container.prototype.defineResource=function(e,t){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(e,t)},Container.prototype.getAdapter=function(e){var t=this.getAdapterName(e);if(!t)throw b.err(ae+"#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},Container.prototype.getAdapterName=function(e){return void 0===e&&(e={}),b.isString(e)&&(e={adapter:e}),e.adapter||this.mapperDefaults.defaultAdapter},Container.prototype.getAdapters=function(){return this._adapters},Container.prototype.getMapper=function(e){var t=this.getMapperByName(e);if(!t)throw b.err(ae+"#getMapper",e)(404,"mapper");return t},Container.prototype.getMapperByName=function(e){return this._mappers[e]},Container.prototype.registerAdapter=function(t,e,n){void 0===n&&(n={}),this.getAdapters()[t]=e,(!0===n||n.default)&&(this.mapperDefaults.defaultAdapter=t,b.forOwn(this._mappers,function(e){e.defaultAdapter=t}))},Container.prototype.count=function(e,t,n){return this.getMapper(e).count(t,n)},Container.prototype.create=function(e,t,n){return this.getMapper(e).create(t,n)},Container.prototype.createMany=function(e,t,n){return this.getMapper(e).createMany(t,n)},Container.prototype.createRecord=function(e,t,n){return this.getMapper(e).createRecord(t,n)},Container.prototype.destroy=function(e,t,n){return this.getMapper(e).destroy(t,n)},Container.prototype.destroyAll=function(e,t,n){return this.getMapper(e).destroyAll(t,n)},Container.prototype.find=function(e,t,n){return this.getMapper(e).find(t,n)},Container.prototype.findAll=function(e,t,n){return this.getMapper(e).findAll(t,n)},Container.prototype.getSchema=function(e){return this.getMapper(e).getSchema()},Container.prototype.is=function(e,t){return this.getMapper(e).is(t)},Container.prototype.sum=function(e,t,n,r){return this.getMapper(e).sum(t,n,r)},Container.prototype.toJSON=function(e,t,n){return this.getMapper(e).toJSON(t,n)},Container.prototype.update=function(e,t,n,r){return this.getMapper(e).update(t,n,r)},Container.prototype.updateAll=function(e,t,n,r){return this.getMapper(e).updateAll(t,n,r)},Container.prototype.updateMany=function(e,t,n){return this.getMapper(e).updateMany(t,n)},Container.prototype.validate=function(e,t,n){return this.getMapper(e).validate(t,n)},Container}(p),le=["add","between","createIndex","filter","get","getAll","prune","query","toJSON","unsaved"],ce=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],pe=function(e,t,n){var r=this._completedQueries[e][t];return b.isFunction(r)?r(e,t,n):r},fe={usePendingFind:!0,usePendingFindAll:!0},de=function(l){function SimpleStore(e){void 0===e&&(e={});var t=l.call(this,r(r({},fe),e))||this;return t._collections={},t._completedQueries={},t._pendingQueries={},t.cachedFind=pe,t.cachedFindAll=pe,t.collectionClass=t.collectionClass||K,t}return __extends(SimpleStore,l),SimpleStore.prototype._end=function(e,t,n){var r=n.raw?t.data:t;return r&&b.isFunction(this.addToCache)&&(r=this.addToCache(e,r,n),n.raw?t.data=r:t=r),t},SimpleStore.prototype._onCollectionEvent=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=t.shift();this.emit.apply(this,__spreadArrays([r,e],t))},SimpleStore.prototype.addToCache=function(e,t,n){return this.getCollection(e).add(t,n)},SimpleStore.prototype.as=function(r){var e={},i=this;return ce.concat(se).concat(le).forEach(function(n){e[n]={writable:!0,value:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i[n].apply(i,__spreadArrays([r],e))}}}),e.getMapper={writable:!0,value:function(){return i.getMapper(r)}},e.getCollection={writable:!0,value:function(){return i.getCollection(r)}},Object.create(this,e)},SimpleStore.prototype.cacheFind=function(e,t,n,r){var i=this;this._completedQueries[e][n]=function(e,t,n){return i.get(e,t)}},SimpleStore.prototype.cacheFindAll=function(e,t,n,r){var i=this;this._completedQueries[e][n]=function(e,t,n){return i.filter(e,b.fromJson(t))}},SimpleStore.prototype.clear=function(){var n=this,r={};return b.forOwn(this._collections,function(e,t){r[t]=e.removeAll(),n._completedQueries[t]={}}),r},SimpleStore.prototype.create=function(t,e,n){var r=this;return void 0===n&&(n={}),l.prototype.create.call(this,t,e,n).then(function(e){return r._end(t,e,n)})},SimpleStore.prototype.createMany=function(t,e,n){var r=this;return void 0===n&&(n={}),l.prototype.createMany.call(this,t,e,n).then(function(e){return r._end(t,e,n)})},SimpleStore.prototype.defineMapper=function(n,e){void 0===e&&(e={});var r=this,t=l.prototype.defineMapper.call(this,n,e);r._pendingQueries[n]={},r._completedQueries[n]={},t.relationList||Object.defineProperty(t,"relationList",{value:[]});var i={_added:{},datastore:this,mapper:t};e&&"onConflict"in e&&(i.onConflict=e.onConflict);var o=r._collections[n]=new r.collectionClass(null,i),a=(t.schema||{}).properties||{};return b.forOwn(a,function(e,t){e.indexed&&o.createIndex(t)}),o.createIndex("addedTimestamps",["$"],{fieldGetter:function(e){return o._added[o.recordId(e)]}}),o.on("all",function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];r._onCollectionEvent.apply(r,__spreadArrays([n],e))}),t},SimpleStore.prototype.destroy=function(n,r,i){var o=this;return void 0===i&&(i={}),l.prototype.destroy.call(this,n,r,i).then(function(e){var t=o.getCollection(n).remove(r,i);return i.raw?e.data=t:e=t,delete o._pendingQueries[n][r],delete o._completedQueries[n][r],e})},SimpleStore.prototype.destroyAll=function(r,i,o){var a=this;return void 0===o&&(o={}),l.prototype.destroyAll.call(this,r,i,o).then(function(e){var t=a.getCollection(r).removeAll(i,o);o.raw?e.data=t:e=t;var n=a.hashQuery(r,i,o);return delete a._pendingQueries[r][n],delete a._completedQueries[r][n],e})},SimpleStore.prototype.eject=function(e,t,n){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(e,t,n)},SimpleStore.prototype.ejectAll=function(e,t,n){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(e,t,n)},SimpleStore.prototype.find=function(t,n,r){var i=this;void 0===r&&(r={});var e=this.getMapper(t),o=this._pendingQueries[t][n],a=void 0===r.usePendingFind?this.usePendingFind:r.usePendingFind;if(b._(r,e),o&&(b.isFunction(a)?a.call(this,t,n,r):a))return o;var s=this.cachedFind(t,n,r);return r.force||!s?(this._pendingQueries[t][n]=l.prototype.find.call(this,t,n,r)).then(function(e){return delete i._pendingQueries[t][n],e=i._end(t,e,r),i.cacheFind(t,e,n,r),e},function(e){return delete i._pendingQueries[t][n],b.reject(e)}):b.resolve(s)},SimpleStore.prototype.findAll=function(t,e,n){var r=this;void 0===n&&(n={});var i=this.getMapper(t),o=this.hashQuery(t,e,n),a=this._pendingQueries[t][o],s=void 0===n.usePendingFindAll?this.usePendingFindAll:n.usePendingFindAll;if(b._(n,i),a&&(b.isFunction(s)?s.call(this,t,e,n):s))return a;var u=this.cachedFindAll(t,o,n);return n.force||!u?(this._pendingQueries[t][o]=l.prototype.findAll.call(this,t,e,n)).then(function(e){return delete r._pendingQueries[t][o],e=r._end(t,e,n),r.cacheFindAll(t,e,o,n),e},function(e){return delete r._pendingQueries[t][o],b.reject(e)}):b.resolve(u)},SimpleStore.prototype.getCollection=function(e){var t=this._collections[e];if(!t)throw b.err("SimpleStore#getCollection",e)(404,"collection");return t},SimpleStore.prototype.hashQuery=function(e,t,n){return b.toJson(t||{})},SimpleStore.prototype.inject=function(e,t,n){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(e,t,n)},SimpleStore.prototype.remove=function(e,t,n){var r=this.getCollection(e).remove(t,n);return r&&this.removeRelated(e,[r],n),r},SimpleStore.prototype.removeAll=function(e,t,n){t&&Object.keys(t).length?this._completedQueries[e][this.hashQuery(e,t,n)]=void 0:this._completedQueries[e]={};var r=this.getCollection(e).removeAll(t,n);return r.length&&this.removeRelated(e,r,n),r},SimpleStore.prototype.removeRelated=function(e,t,n){var u=this;b.isArray(t)||(t=[t]),b.forEachRelation(this.getMapper(e),n,function(a,s){t.forEach(function(e){var t,n,r,i,o;if(!a.foreignKey||a.type!==S&&a.type!==x?a.type===x&&a.localKeys?o={where:(n={},n[a.getRelation().idAttribute]={in:b.get(e,a.localKeys)},n)}:a.type===x&&a.foreignKeys?o={where:(r={},r[a.foreignKeys]={contains:a.getForeignKey(e)},r)}:a.type===R&&(i=u.remove(a.relation,a.getForeignKey(e),s)):((t={})[a.foreignKey]=a.getForeignKey(e),o=t),o&&(i=u.removeAll(a.relation,o,s)),i){if(b.isArray(i)&&!i.length)return;a.type===S&&(i=i[0]),a.setLocalField(e,i)}})})},SimpleStore.prototype.update=function(t,e,n,r){var i=this;return void 0===r&&(r={}),l.prototype.update.call(this,t,e,n,r).then(function(e){return i._end(t,e,r)})},SimpleStore.prototype.updateAll=function(t,e,n,r){var i=this;return void 0===r&&(r={}),l.prototype.updateAll.call(this,t,e,n,r).then(function(e){return i._end(t,e,r)})},SimpleStore.prototype.updateMany=function(t,e,n){var r=this;return void 0===n&&(n={}),l.prototype.updateMany.call(this,t,e,n).then(function(e){return r._end(t,e,n)})},SimpleStore.prototype.add=function(e,t,n){return this.getCollection(e).add(t,n)},SimpleStore.prototype.between=function(e,t,n,r){return this.getCollection(e).between(t,n,r)},SimpleStore.prototype.createIndex=function(e,t,n,r){return this.getCollection(e).createIndex(t,n,r)},SimpleStore.prototype.filter=function(e,t,n){return this.getCollection(e).filter(t,n)},SimpleStore.prototype.get=function(e,t){return this.getCollection(e).get(t)},SimpleStore.prototype.getAll=function(e){for(var t,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return(t=this.getCollection(e)).getAll.apply(t,n)},SimpleStore.prototype.prune=function(e,t){return this.getCollection(e).prune(t)},SimpleStore.prototype.query=function(e){return this.getCollection(e).query()},SimpleStore.prototype.toJSON=function(e,t){return this.getCollection(e).toJSON(t)},SimpleStore.prototype.unsaved=function(e,t){return this.getCollection(e).unsaved(t)},SimpleStore}(ue),he=function(a){function LinkedCollection(e,t){var n=a.call(this,e,t)||this;if(!n.datastore)throw b.err("new LinkedCollection","opts.datastore")(400,"DataStore",n.datastore);return n}return __extends(LinkedCollection,a),LinkedCollection.prototype._addMeta=function(e,t){this._added[this.recordId(e)]=t,b.isFunction(e._set)&&e._set("$",t)},LinkedCollection.prototype._clearMeta=function(e){delete this._added[this.recordId(e)],b.isFunction(e._set)&&e._set("$")},LinkedCollection.prototype._onRecordEvent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];K.prototype._onRecordEvent.apply(this,e);var n=e[0];b.isString(n)&&0===n.indexOf("change")&&this.updateIndexes(e[1])},LinkedCollection.prototype.add=function(t,e){var n=this,r=this.mapper,i=(new Date).getTime(),o=b.isObject(t)&&!b.isArray(t);return o&&(t=[t]),t=a.prototype.add.call(this,t,e),r.relationList.length&&t.length&&r.relationList.forEach(function(e){e.addLinkedRecords(t)}),t.forEach(function(e){return n._addMeta(e,i)}),o?t[0]:t},LinkedCollection.prototype.remove=function(e,t){var n=this.mapper,r=a.prototype.remove.call(this,e,t);return r&&this._clearMeta(r),n.relationList.length&&r&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,[r])}),r},LinkedCollection.prototype.removeAll=function(e,t){var n=this.mapper,r=a.prototype.removeAll.call(this,e,t);return r.forEach(this._clearMeta,this),n.relationList.length&&r.length&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,r)}),r},LinkedCollection}(K),ve={unlinkOnDestroy:!0,collectionClass:he},ye=function(n){function DataStore(e){return void 0===e&&(e={}),n.call(this,r(r({},ve),e))||this}return __extends(DataStore,n),DataStore.prototype.defineMapper=function(e,t){var m=this,_=n.prototype.defineMapper.call(this,e,t),A=_.idAttribute,l=this.getCollection(e);return _.relationList.forEach(function(c){var e,p=c.relation,f=c.localField,d="links."+f,h=c.foreignKey,t=c.type,v={index:h},n=function(){return this._get(d)};if(t===R){l.indexes[h]||l.createIndex(h),e={get:n,set:function(e){var t=this._get(d);if(e===t)return t;var n=b.get(this,A),r=c.getInverse(_);if(t&&r&&this.removeInverseRelation(t,n,r,A),e){var i=c.getRelation().idAttribute,o=b.get(e,i);void 0!==o&&this._get("$")&&(e=m.get(p,o)||e),C(this,f,e),O(this,h,o),l.updateIndex(this,v),r&&this.setupInverseRelation(e,n,r,A)}else C(this,f,void 0);return e}};var r=Object.getOwnPropertyDescriptor(_.recordClass.prototype,h);r||(r={enumerable:!0});var i=r.get;r.get=function(){return i?i.call(this):this._get("props."+h)};var u=r.set;r.set=function(e){var t=this;u&&u.call(this,e);var n=b.get(this,f),r=b.get(this,A),i=c.getInverse(_),o=n?b.get(n,c.getRelation().idAttribute):void 0;if(i&&n&&void 0!==o&&o!==e)if(i.type===S)C(n,i.localField,void 0);else if(i.type===x){var a=b.get(n,i.localField);void 0===r?b.remove(a,function(e){return e===t}):b.remove(a,function(e){return e===t||r===b.get(e,A)})}if(O(this,h,e),l.updateIndex(this,v),null==e)void 0!==o&&b.set(this,f,void 0);else if(this._get("$")){var s=m.get(p,e);s&&b.set(this,f,s)}},Object.defineProperty(_.recordClass.prototype,h,r)}else if(t===x){var y=c.localKeys,g=c.foreignKeys;m._collections[p]&&h&&!m.getCollection(p).indexes[h]&&m.getCollection(p).createIndex(h),e={get:function(){return n.call(this)||this._set(d,[]),n.call(this)},set:function(n){var i=this;n&&!b.isArray(n)&&(n=[n]);var r=b.get(this,A),o=c.getRelation().idAttribute,e=c.getInverse(_),a=e.localField,t=this._get(d)||[],s=[],u={};if(n&&n.forEach(function(t){var n=b.get(t,o),e=b.get(t,a);if(e&&e!==i){var r=b.get(e,f);void 0===n?b.remove(r,function(e){return e===t}):b.remove(r,function(e){return e===t||n===b.get(e,o)})}void 0!==n&&(i._get("$")&&(t=m.get(p,n)||t),u[n]=t),s.push(t)}),h)t.forEach(function(e){var t=b.get(e,o);(void 0===t&&-1===s.indexOf(e)||void 0!==t&&!(t in u))&&(n&&(O(e,h,void 0),m.getCollection(p).updateIndex(e,v)),C(e,a,void 0))}),s.forEach(function(e){O(e,h,r),m.getCollection(p).updateIndex(e,v),C(e,a,i)});else if(y){var l=s.map(function(e){return b.get(e,o)}).filter(function(e){return void 0!==e});b.set(this,y,l),e.foreignKeys&&(t.forEach(function(e){var t=b.get(e,o);if(void 0===t&&-1===s.indexOf(e)||void 0!==t&&!(t in u)){var n=b.get(e,a)||[];void 0===r?b.remove(n,function(e){return e===i}):b.remove(n,function(e){return e===i||r===b.get(e,A)})}}),s.forEach(function(e){var t=b.get(e,a);void 0===r?b.noDupeAdd(t,i,function(e){return e===i}):b.noDupeAdd(t,i,function(e){return e===i||r===b.get(e,A)})}))}else g&&(t.forEach(function(e){var t=b.get(e,g)||[];b.remove(t,function(e){return r===e});var n=b.get(e,a);void 0===r?b.remove(n,function(e){return e===i}):b.remove(n,function(e){return e===i||r===b.get(e,A)})}),s.forEach(function(e){var t=b.get(e,g)||[];b.noDupeAdd(t,r,function(e){return r===e});var n=b.get(e,a);void 0===r?b.noDupeAdd(n,i,function(e){return e===i}):b.noDupeAdd(n,i,function(e){return e===i||r===b.get(e,A)})}));return this._set(d,s),s}}}else t===S&&(m._collections[p]&&h&&!m.getCollection(p).indexes[h]&&m.getCollection(p).createIndex(h),e={get:n,set:function(e){var t=this._get(d);if(e===t)return t;var n=c.getInverse(_).localField;if(t&&(O(t,h,void 0),m.getCollection(p).updateIndex(t,v),C(t,n,void 0)),e){var r=b.get(e,c.getRelation().idAttribute);void 0!==r&&(e=m.get(p,r)||e),C(this,f,e),O(e,h,b.get(this,A)),m.getCollection(p).updateIndex(e,v),C(e,n,this)}else C(this,f,void 0);return e}});if(e){if(e.enumerable=void 0!==c.enumerable&&c.enumerable,c.get){var o=e.get;e.get=function(){var n=this;return c.get(c,this,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return o.apply(n,e)})}}if(c.set){var a=e.set;e.set=function(t){var n=this;return c.set(c,this,t,function(e){return a.call(n,void 0===e?t:e)})}}Object.defineProperty(_.recordClass.prototype,f,e)}}),_},DataStore.prototype.destroy=function(r,e,i){var o=this;return void 0===i&&(i={}),n.prototype.destroy.call(this,r,e,i).then(function(e){var t;if((t=i.raw?e.data:e)&&o.unlinkOnDestroy){var n=b.plainCopy(i);n.withAll=!0,b.forEachRelation(o.getMapper(r),n,function(e){b.set(t,e.localField,void 0)})}return e})},DataStore.prototype.destroyAll=function(i,e,o){var a=this;return void 0===o&&(o={}),n.prototype.destroyAll.call(this,i,e,o).then(function(e){var t,n;if((null===(t=n=o.raw?e.data:e)||void 0===t?void 0:t.length)&&a.unlinkOnDestroy){var r=b.plainCopy(o);r.withAll=!0,b.forEachRelation(a.getMapper(i),r,function(t){n.forEach(function(e){b.set(e,t.localField,void 0)})})}return e})},DataStore}(de);e.Collection=K,e.Component=p,e.Container=ue,e.DataStore=ye,e.Index=F,e.LinkedCollection=he,e.Mapper=oe,e.Query=m,e.Record=I,e.Schema=z,e.Settable=c,e.SimpleStore=de,e.belongsTo=belongsTo,e.belongsToType=R,e.hasMany=hasMany,e.hasManyType=x,e.hasOne=hasOne,e.hasOneType=S,e.utils=b,e.version={full:"3.0.6",major:3,minor:0,patch:6},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=js-data.min.map